BEGIN TRANSACTION   
--ROLLBACK  
--COMMIT                                                                                                     
               
/*-----------------------------------------------------------------------------------------------------------------------*/
/* 0001 - 29.04.2022 BRUNO SANTANA  - AJUSTE VALE CREDITO TELENTREGA PARA CONSIDERAR O MOVIMENTO DO RECEBIMENTO          */
/* 0002 - 20.05.2022 BRUNO SANTANA  - REMOVER RELACAO DE CAIXA POIS NO RECEBIMENTO POIS NEM SEMPRE O CAIXA QUE           */
/*                                    SAI O ROMANEIO É O CAIXA QUE RECEBE                                                */
/* 0003 - 22.07.2022 BRUNO SANTANA  - CONSIDERAR FORMULARIO DE MANUTENCOES DE FECHAMENTO DE CAIXA PREVENDO SOBRA E FALTA */
/* 0004 - 03.08.2022 BRUNO SANTANA  - INSERCAO DAS OCORRENCIAS DOS CAIXAS FECHADOS                                       */
/* 0005 - 07.08.2022 BRUNO SANTANA  - INSERCAO CAMPO OPERADOR NA OBERVAÇÃO                                               */
/* 0006 - 08.08.2022 ANDERSON SILVA - INSERÇAO DA TRATATIVA PARA ALTERAR PARA CONFERIDO AS VENDAS POS QUE FORAM          */
/*                                    CONCILIADAS                                                                        */
/* 0007 - 13.08.2022 BRUNO SANTANA  - CORRECAO DO BLOCO PBM ONDE PASSAMOS A FAZER A VINCULACAO PELO CAIXA_ORIGINAL       */  
/*-----------------------------------------------------------------------------------------------------------------------*/ 

SET DATEFORMAT DMY                                       
                               
DECLARE @CONFERENCIA_FECHAMENTO_CAIXA    NUMERIC(15)   = 65192--65191--63935--63797--61361--52608
DECLARE @MOVIMENTO                       DATE          = '09/08/2022'--'26/06/2022'--'07/06/2022'--'24/03/2022'
DECLARE @EMPRESA                         NUMERIC(15)   = 74 --22--47--4--3
DECLARE @VALOR_MINIMO_VALE_FUNCIONARIO   NUMERIC(15,2) = ( SELECT VALOR_MINIMO_VALE_FUNCIONARIO FROM PARAMETROS_VENDAS A WITH(NOLOCK) WHERE EMPRESA_USUARIA =  @EMPRESA )
DECLARE @MENSAGEM                        VARCHAR(500)   

-- DECLARE @CONFERENCIA_FECHAMENTO_CAIXA  NUMERIC(15)   = :CONFERENCIA_FECHAMENTO_CAIXA
-- DECLARE @MOVIMENTO                     DATE          = :MOVIMENTO
-- DECLARE @VALOR_MINIMO_VALE_FUNCIONARIO NUMERIC(15,2) = ( SELECT VALOR_MINIMO_VALE_FUNCIONARIO FROM PARAMETROS_VENDAS A WITH(NOLOCK) WHERE EMPRESA_USUARIA = :EMPRESA )
-- DECLARE @EMPRESA                       NUMERIC(15)   = :EMPRESA
-- DECLARE @MENSAGEM                      VARCHAR(500)
         
SELECT TOP 1
    @MENSAGEM = 'Abertura de caixa ' + CONVERT(VARCHAR(50),A.ABERTURA) + ' não possui fechamento!'
FROM
    PDV_CAIXAS           A WITH(NOLOCK)
LEFT 
JOIN FECHAMENTOS_CAIXAS   B WITH(NOLOCK)ON B.MOVIMENTO       = A.MOVIMENTO
                                       AND B.ABERTURA_CAIXA  = A.ABERTURA
                                       AND B.EMPRESA         = A.LOJA
                                       AND B.CAIXA_LOJA      = A.CAIXA
WHERE
    A.MOVIMENTO = @MOVIMENTO
AND A.LOJA      = @EMPRESA
AND B.FECHAMENTO_CAIXA IS NULL

IF @MENSAGEM IS NOT NULL

BEGIN
                
    RAISERROR(@MENSAGEM, 16, 1)
    RETURN

END         
         
PRINT '------------------------------------------------------------'
PRINT '-- CRIACAO DE TABELAS TEMPORÁRIAS PARA DELETAR AS DETAILS --'
PRINT '-- ESTA AÇÃO FOI NECESSÁRIA POIS QUANDO DOIS USUÁRIOS     --'
PRINT '-- TENTAVAM USAR O PROCESSO AO MESMO TEMPO TRAVAVA        --'
PRINT '------------------------------------------------------------'

   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS'    ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS'           ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO'     ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES'      ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF'              ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_POS'              ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_POS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS'        ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS'        ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM'              ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS'        ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC'       ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS'        ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_CHEQUES'          ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_CHEQUES
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS'         ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO'     ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES'       ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS') IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES'      ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES
                                                       
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_FINALIZADORA    INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS     WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_ENVIO           INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS            FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS            WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_DEP_DINHEIRO    INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO      FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO      WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_DEP_CHEQUE      INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES       FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES       WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_TEF             INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF               FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF               WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_POS             INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_POS               FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_POS               WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_CONVENIO        INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS         WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_CPROPRIO        INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS         WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_PBM             INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM               FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM               WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_FATURADO        INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS         WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_VALE_FUNC       INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC        FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC        WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_VCREDITO        INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS         WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_CHEQUE          INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_CHEQUES           FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CHEQUES           WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_DESPESA         INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS          FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS          WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_DEV_DINHEIRO    INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO      FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO      WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_DEVOLUCAO       INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES        FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES        WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_CUPOM_CANCELADO INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'
   SELECT CONFERENCIA_FECHAMENTO_CAIXA_OBSERVACAO      INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES        FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES       WITH(NOLOCK) WHERE CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA AND CONFERIDO = 'N'

PRINT '---------------------------------------------------------'
PRINT '-- DELETA AS MOVIMENTAÇÕES DO REGISTRO PARA REGERA-LAS --'
PRINT '---------------------------------------------------------'

   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS     A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS     B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_FINALIZADORA    = A.CONFERENCIA_FECHAMENTO_CAIXA_FINALIZADORA
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS            FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS            A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS            B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_ENVIO           = A.CONFERENCIA_FECHAMENTO_CAIXA_ENVIO       
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO      FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO      A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO      B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_DEP_DINHEIRO    = A.CONFERENCIA_FECHAMENTO_CAIXA_DEP_DINHEIRO
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES       FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES       A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES       B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_DEP_CHEQUE      = A.CONFERENCIA_FECHAMENTO_CAIXA_DEP_CHEQUE  
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF               FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF               A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF               B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_TEF             = A.CONFERENCIA_FECHAMENTO_CAIXA_TEF         
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_POS               FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_POS               A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_POS               B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_POS             = A.CONFERENCIA_FECHAMENTO_CAIXA_POS         
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS         A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS         B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_CONVENIO        = A.CONFERENCIA_FECHAMENTO_CAIXA_CONVENIO    
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS         A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS         B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_CPROPRIO        = A.CONFERENCIA_FECHAMENTO_CAIXA_CPROPRIO    
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM               FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM               A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM               B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_PBM             = A.CONFERENCIA_FECHAMENTO_CAIXA_PBM         
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS         A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS         B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_FATURADO        = A.CONFERENCIA_FECHAMENTO_CAIXA_FATURADO    
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC        FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC        A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC        B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_VALE_FUNC       = A.CONFERENCIA_FECHAMENTO_CAIXA_VALE_FUNC   
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS         FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS         A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS         B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_VCREDITO        = A.CONFERENCIA_FECHAMENTO_CAIXA_VCREDITO    
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_CHEQUES           FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CHEQUES           A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_CHEQUES           B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_CHEQUE          = A.CONFERENCIA_FECHAMENTO_CAIXA_CHEQUE      
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS          FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS          A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS          B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_DESPESA         = A.CONFERENCIA_FECHAMENTO_CAIXA_DESPESA     
   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO      FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO      A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO      B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_DEV_DINHEIRO    = A.CONFERENCIA_FECHAMENTO_CAIXA_DEV_DINHEIRO

   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES        FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES        A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES        B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_DEVOLUCAO       = A.CONFERENCIA_FECHAMENTO_CAIXA_DEVOLUCAO

   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_CUPOM_CANCELADO = A.CONFERENCIA_FECHAMENTO_CAIXA_CUPOM_CANCELADO

   DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES        FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES      A WITH(NOLOCK) JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES       B WITH(NOLOCK) ON B.CONFERENCIA_FECHAMENTO_CAIXA_OBSERVACAO      = A.CONFERENCIA_FECHAMENTO_CAIXA_OBSERVACAO

PRINT '-------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A FINALIZADORAS --'
PRINT '-------------------------------------------------------------'

   IF OBJECT_ID('TEMPDB..#ENTRADAS'      ) IS NOT NULL DROP TABLE #ENTRADAS
   IF OBJECT_ID('TEMPDB..#SANGRIAS'      ) IS NOT NULL DROP TABLE #SANGRIAS
   IF OBJECT_ID('TEMPDB..#CONTAGEM'      ) IS NOT NULL DROP TABLE #CONTAGEM
   IF OBJECT_ID('TEMPDB..#RECARGAS'      ) IS NOT NULL DROP TABLE #RECARGAS
   IF OBJECT_ID('TEMPDB..#RECEBTOS'      ) IS NOT NULL DROP TABLE #RECEBTOS
   IF OBJECT_ID('TEMPDB..#TROCO_INICIAL' ) IS NOT NULL DROP TABLE #TROCO_INICIAL
   IF OBJECT_ID('TEMPDB..#QUEBRA_CAIXA'  ) IS NOT NULL DROP TABLE #QUEBRA_CAIXA
   IF OBJECT_ID('TEMPDB..#SOBRA_CAIXA'   ) IS NOT NULL DROP TABLE #SOBRA_CAIXA
   IF OBJECT_ID('TEMPDB..#SUPRIMENTOS'   ) IS NOT NULL DROP TABLE #SUPRIMENTOS
   IF OBJECT_ID('TEMPDB..#DEVOLUCOES'    ) IS NOT NULL DROP TABLE #DEVOLUCOES
   
   IF OBJECT_ID('TEMPDB..#RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS'    ) IS NOT NULL DROP TABLE #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS

/*
   SELECT @CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.*
     INTO #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS
     FROM PDV_VENDAS_FECHAMENTOS_CAIXAS ( @MOVIMENTO ,
                                          @MOVIMENTO ,
                                          @EMPRESA ,
                                          @EMPRESA ) B
*/  

   SELECT @CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.*
     INTO #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS

     FROM VW_PDV_VENDAS_FECHAMENTOS_CAIXAS B
     JOIN PDV_VENDAS                       C WITH(NOLOCK)ON C.VENDA     = B.VENDA_ORIGINAL
                                                        AND C.LOJA      = B.LOJA_ORIGINAL
                                                        AND C.CAIXA     = B.CAIXA_ORIGINAL
                                                        AND C.MOVIMENTO = B.MOVIMENTO_ORIGINAL
                                                        AND C.STATUS    = 'A'
    WHERE B.MOVIMENTO >= @MOVIMENTO   
      AND B.MOVIMENTO <= @MOVIMENTO
      AND B.LOJA      >= @EMPRESA
      AND B.LOJA      <= @EMPRESA
      AND B.TIPO_VENDA_FECHAMENTO_CAIXA      
                      IN (1,3)

UNION ALL
     
   SELECT @CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.*
     FROM VW_PDV_VENDAS_FECHAMENTOS_CAIXAS B

    WHERE B.MOVIMENTO >= @MOVIMENTO
      AND B.MOVIMENTO <= @MOVIMENTO
      AND B.LOJA      >= @EMPRESA
      AND B.LOJA      <= @EMPRESA
      AND B.TIPO_VENDA_FECHAMENTO_CAIXA      
                      IN (2)         
                      
--PROCESSO DA CONCILIAÇÃO DE CARTÕES 0006
PRINT '-- ALTERAÇÃO DE DADOS BASEADO NA MANUTENÇÃO E CUPOM'        
UPDATE A        
SET PARCELAS            = C.PARCELAS        
  , NSU                 = C.NSU              
  , AUTORIZACAO_TEF     = C.AUTORIZACAO_TEF        
  , CODBANDEIRA         = C.CODBANDEIRA                              
FROM #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)        
JOIN POS_MANUTENCOES_DETALHES                 B WITH(NOLOCK) ON B.EMPRESA   = A.LOJA        
                                                            AND B.CAIXA     = A.CAIXA        
                                                            AND B.MOVIMENTO = A.MOVIMENTO     
                                                            AND B.VENDA     = A.VENDA    
                                                            AND B.NSU       = A.NSU        
        
JOIN CONCILIACOES_CARTOES_VENDAS_PBS_CUPONS   C WITH(NOLOCK) ON C.REGISTRO  = B.REGISTRO   


   ----------------------------
   -- GERA DADOS DE ENTRADAS --
   ----------------------------
   SELECT B.TIPO                  AS TIPO_FINALIZADORA ,
          COUNT(DISTINCT B.VENDA) AS QTD_CUPONS        ,

          SUM(CASE WHEN (ISNULL(B.CODIGO_PBM,0) = 0) 
                   --THEN CASE WHEN X.STATUS = 'A' 
                   --          THEN CASE WHEN B.STATUS = 'A' 
                   --                    THEN B.VALOR - B.TROCO 
                   --                    ELSE ( B.VALOR - B.TROCO) * (-1) 
                   --               END 
                   --          ELSE 0 
                   --     END 
                   THEN B.VALOR
                   ELSE 0    
              END) AS VALOR_ENTRADAS,

          SUM(CASE WHEN ISNULL(B.CODIGO_PBM,0) > 0 
                  --AND B.TIPO                 = 5
                   --THEN CASE WHEN X.STATUS = 'A' 
                   --          THEN CASE WHEN B.STATUS = 'A' 
                   --                    THEN B.VALOR - B.TROCO 
                   --                    ELSE ( B.VALOR - B.TROCO) * (-1) 
                   --               END 
                   --          ELSE 0 
                   --     END
                   THEN B.VALOR 
                   ELSE 0 
              END) AS VALOR_PBM,
              0    AS VALOR_DEPOSITO

     INTO #ENTRADAS

    -- FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
    -- JOIN PDV_VENDAS                          X WITH(NOLOCK)ON X.EMPRESA   = A.EMPRESA
    --                                                       AND X.MOVIMENTO = @MOVIMENTO
    -- JOIN PDV_FINALIZADORAS                   B WITH(NOLOCK)ON B.LOJA      = X.LOJA
    --                                                       AND B.MOVIMENTO = X.MOVIMENTO
    --                                                       AND B.VENDA     = X.VENDA
    --                                                       AND B.CAIXA     = X.CAIXA
    --WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
    FROM #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS B    
    WHERE B.ORIGEM <> 'RECARGAS'
    GROUP BY
          B.TIPO

    UNION ALL

   SELECT 99                     AS TIPO_FINALIZADORA ,
          0                      AS QTD_CUPONS        ,
          SUM(ISNULL(A.ENTRADA_TOTAL_DEVOLUCOES,0)) AS VALOR_ENTRADAS,
          0.00       AS VALOR_PBM  ,
          0.00       AS VALOR_DEPOSITO --,

     FROM FECHAMENTOS_CAIXAS A WITH(NOLOCK)
    WHERE A.MOVIMENTO = @MOVIMENTO
      AND A.EMPRESA   = @EMPRESA

   --------------------------------
   -- GERA TABELA DE SUPRIMENTOS --
   --------------------------------
   SELECT 1                      AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.VALOR),0) AS VALOR
     INTO #SUPRIMENTOS
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SUPRIMENTOS                     B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.VALOR,0)               > 0

   -----------------------------
   -- GERA TABEMA DE SANGRIAS --
   -----------------------------
   -- GERA DADOS DE SANGRIAS REFERENTE A DINHEIRO
   
   SELECT 
    X.TIPO_FINALIZADORA AS TIPO_FINALIZADORA,
    SUM(X.VALOR) AS VALOR
    INTO #SANGRIAS
    FROM
   (SELECT 1                     AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.VALOR),0) AS VALOR
     --INTO #SANGRIAS
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.VALOR,0)               > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'

      UNION
   SELECT 1                      AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.VALOR),0) AS VALOR
     
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN TELEVENDAS_SANGRIA                        B WITH(NOLOCK)ON B.EMPRESA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.VALOR,0)               > 0)X

      GROUP BY 
      X.TIPO_FINALIZADORA

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A CHEQUES A VISTA
   SELECT 2                        AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CHEQUES),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CHEQUES,0)             > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A CHEQUES PRÉ-DATADOS
   SELECT 3                           AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.PREDATADOS),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.PREDATADOS,0)          > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A TEF
   SELECT 4                            AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CARTOES_TEF),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CARTOES_TEF,0)         > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'
      AND 1 = 2 --CONFORME ALINHADO COM O ANDREI EM 07/11/2016 SÓ É PRA SUBIR SANGRIAS QUE FOREM DE DINHEIRO, CHEQUE E PRÉ-DATADO

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A CONVENIOS E PBMS
   SELECT 5                          AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONVENIOS),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONVENIOS,0)           > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'
      AND 1 = 2 --CONFORME ALINHADO COM O ANDREI EM 07/11/2016 SÓ É PRA SUBIR SANGRIAS QUE FOREM DE DINHEIRO, CHEQUE E PRÉ-DATADO

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A CARTÕES PRÓPRIOS
   SELECT 6                                AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CARTOES_PROPRIO),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CARTOES_PROPRIO,0)     > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'
      AND 1 = 2 --CONFORME ALINHADO COM O ANDREI EM 07/11/2016 SÓ É PRA SUBIR SANGRIAS QUE FOREM DE DINHEIRO, CHEQUE E PRÉ-DATADO

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A FATURADOS
   SELECT 7                          AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.FATURADOS),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.FATURADOS,0)           > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'
      AND 1 = 2 --CONFORME ALINHADO COM O ANDREI EM 07/11/2016 SÓ É PRA SUBIR SANGRIAS QUE FOREM DE DINHEIRO, CHEQUE E PRÉ-DATADO

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A VALE CREDITOS
   SELECT 8                             AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.VALE_CREDITO),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.VALE_CREDITO,0)        > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'
      AND 1 = 2 --CONFORME ALINHADO COM O ANDREI EM 07/11/2016 SÓ É PRA SUBIR SANGRIAS QUE FOREM DE DINHEIRO, CHEQUE E PRÉ-DATADO

    UNION ALL

   -- GERA DADOS DE SANGRIAS REFERENTE A POS
   SELECT 9                            AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CARTOES_POS),0) AS VALOR
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_SANGRIAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CARTOES_POS,0)         > 0
      --AND ISNULL(B.TIPO_SANGRIA,'N') = 'S'
      AND 1 = 2 --CONFORME ALINHADO COM O ANDREI EM 07/11/2016 SÓ É PRA SUBIR SANGRIAS QUE FOREM DE DINHEIRO, CHEQUE E PRÉ-DATADO

   -----------------------------
   -- GERA TABELA DE CONTAGEM --
   -----------------------------
   -- GERA DADOS DE CONTAGEM REFERENTE A DINHEIRO
   SELECT 1                                  AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_DINHEIRO),0) AS VALOR             
     INTO #CONTAGEM
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA                                                                
      AND ISNULL(B.CONTAGEM_DINHEIRO,0)   > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A CHEQUES
   SELECT 2                                AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_CHEQUE),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_CHEQUE,0)     > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A CHEQUES PRÉ-DATADOS
   SELECT 3                                   AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_PREDATADO),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_PREDATADO,0)  > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A CARTÕES TEF
   SELECT 4                                       AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_CARTAO_CREDITO + 
                     B.CONTAGEM_CARTAO_DEBITO),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_CARTAO_CREDITO + 
                 B.CONTAGEM_CARTAO_DEBITO,0) > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A CONVENIOS E PBMS
   SELECT 5                                          AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_CONVENIO_EMPRESA),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_CONVENIO_EMPRESA,0)  > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A CARTÕES PRÓPRIOS
   SELECT 6                                        AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_CARTAO_PROPRIO),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA      = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_CARTAO_PROPRIO,0) > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A FATURADOS
   SELECT 7                                AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_BOLETO),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_BOLETO,0)    > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A VALE CREDITOS
   SELECT 8                                      AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_VALE_CREDITO),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA    = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_VALE_CREDITO,0) > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A CARTÕES POS
   SELECT 9                                       AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_CARTAO_CREDITO_POS + 
                     B.CONTAGEM_CARTAO_DEBITO_POS),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(B.CONTAGEM_CARTAO_CREDITO_POS + B.CONTAGEM_CARTAO_DEBITO_POS,0)  > 0

    UNION ALL

   -- GERA DADOS DE CONTAGEM REFERENTE A DEVOLUCOES
   SELECT 99                                         AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.CONTAGEM_TOTAL_DEVOLUCOES),0) AS VALOR             
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
     -- AND ISNULL(B.CONTAGEM_TOTAL_DEVOLUCOES,0)  > 0

   --------------------------------------------
   -- GERA TABELA COM VALOR DO TROCO INICIAL --
   --------------------------------------------
   SELECT 1                                      AS TIPO_FINALIZADORA ,
          ISNULL(SUM(B.TROCO_INICIAL_CONTADO),0) AS VALOR             ,
          ISNULL(SUM(B.ENTRADA_TROCO),0)         AS TROCO_ENTRADA     ,
          ISNULL(SUM(B.TROCO_SAIDA  ),0)         AS TROCO_SAIDA              
     INTO #TROCO_INICIAL
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN FECHAMENTOS_CAIXAS              B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ( ISNULL(B.TROCO_INICIAL_CONTADO,0)   > 0
            OR
            ISNULL(B.ENTRADA_TROCO,0) > 0
            OR
            ISNULL(B.TROCO_SAIDA  ,0) > 0 )


   
--------------------------------------------------------------------
-- GERA TABELA COM VALOR DA QUEBRA DE CAIXA NEW - TAREFA 126880   --
--------------------------------------------------------------------   
   
SELECT DISTINCT
    X.TIPO_FINALIZADORA      AS TIPO_FINALIZADORA  
   ,SUM(X.VALOR_VALE)        AS VALOR_VALE    
   ,SUM(X.VALOR_PERMITIDO)   AS VALOR_PERMITIDO 
INTO
    #QUEBRA_CAIXA
FROM
(
 --CAIXAS QUE JÁ POSSUIAM QUEBRA DE CAIXA--
 SELECT DISTINCT
     1                                              AS TIPO_FINALIZADORA
    ,CASE WHEN ISNULL(B.VALE_DIFERENCA,0) > ISNULL(D.VALOR_JUSTIFICAVEL,0)
           AND ISNULL(B.VALE_DIFERENCA,0) - ISNULL(D.VALOR_JUSTIFICAVEL,0) > @VALOR_MINIMO_VALE_FUNCIONARIO 
          THEN ISNULL(B.VALE_DIFERENCA,0) - ISNULL(D.VALOR_JUSTIFICAVEL,0)
          ELSE 0
     END                                            AS VALOR_VALE
    ,CASE WHEN ISNULL(B.VALE_DIFERENCA,0) > ISNULL(D.VALOR_JUSTIFICAVEL,0)
           AND ISNULL(B.VALE_DIFERENCA,0) - ISNULL(D.VALOR_JUSTIFICAVEL,0) <= @VALOR_MINIMO_VALE_FUNCIONARIO 
          THEN ISNULL(B.VALE_DIFERENCA,0) - ISNULL(D.VALOR_JUSTIFICAVEL,0)
          ELSE 0
     END                                            AS VALOR_PERMITIDO
 FROM
     CONFERENCIAS_FECHAMENTOS_CAIXAS            A WITH(NOLOCK)
 JOIN
     FECHAMENTOS_CAIXAS                         B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                             AND B.MOVIMENTO = A.MOVIMENTO
 LEFT JOIN
     DL_FECHAMENTOS_CAIXAS_MANUTENCOES_FALTAS   D WITH(NOLOCK)ON D.REGISTRO  = B.FECHAMENTO_CAIXA
 WHERE
     A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
 AND ISNULL(B.VALE_DIFERENCA,0)      > 0
     
     UNION ALL
   
 --CAIXAS QUE POSSUIAM SOBRA DE CAIXA--
 SELECT DISTINCT
     1                                              AS TIPO_FINALIZADORA
    ,CASE WHEN ISNULL(D.VALOR_JUSTIFICAVEL,0) > ISNULL(D.VALOR_SOBRA,0)
           AND ISNULL(D.VALOR_JUSTIFICAVEL,0) - ISNULL(D.VALOR_SOBRA,0) > @VALOR_MINIMO_VALE_FUNCIONARIO
          THEN ISNULL(D.VALOR_JUSTIFICAVEL,0) - ISNULL(D.VALOR_SOBRA,0)
          ELSE 0
     END                                            AS VALOR_VALE
    ,CASE WHEN ISNULL(D.VALOR_JUSTIFICAVEL,0) > ISNULL(D.VALOR_SOBRA,0)
           AND ISNULL(D.VALOR_JUSTIFICAVEL,0) - ISNULL(D.VALOR_SOBRA,0) <= @VALOR_MINIMO_VALE_FUNCIONARIO 
          THEN ISNULL(D.VALOR_JUSTIFICAVEL,0) - ISNULL(D.VALOR_SOBRA,0)
          ELSE 0
     END                                            AS VALOR_PERMITIDO
 FROM
     CONFERENCIAS_FECHAMENTOS_CAIXAS            A WITH(NOLOCK)
 JOIN
     FECHAMENTOS_CAIXAS                         B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                             AND B.MOVIMENTO = A.MOVIMENTO
 LEFT JOIN
     DL_FECHAMENTOS_CAIXAS_MANUTENCOES_SOBRAS   D WITH(NOLOCK)ON D.REGISTRO  = B.FECHAMENTO_CAIXA
 WHERE
     A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
 AND ISNULL(D.VALOR_JUSTIFICAVEL,0) - ISNULL(D.VALOR_SOBRA,0) > 0
) X 
GROUP BY
    X.TIPO_FINALIZADORA
   
   
------------------------------------------------------
-- GERA TABELA COM VALOR DA SOBRA DE CAIXA NEW     --
------------------------------------------------------

SELECT
    X.TIPO_FINALIZADORA      AS TIPO_FINALIZADORA
   ,ISNULL(SUM(X.VALOR),0)   AS VALOR
INTO
    #SOBRA_CAIXA
FROM
(
 --CAIXAS QUE JÁ POSSUIAM SOBRA DE CAIXA--
 SELECT DISTINCT
     1                                              AS TIPO_FINALIZADORA
    ,CASE WHEN ISNULL(B.SOBRA_CAIXA,0) > ISNULL(D.VALOR_JUSTIFICAVEL,0)
          THEN ISNULL(B.SOBRA_CAIXA,0) - ISNULL(D.VALOR_JUSTIFICAVEL,0)
          ELSE 0
     END                                            AS VALOR
 FROM
     CONFERENCIAS_FECHAMENTOS_CAIXAS            A WITH(NOLOCK)
 JOIN
     FECHAMENTOS_CAIXAS                         B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                             AND B.MOVIMENTO = A.MOVIMENTO
 LEFT JOIN
     DL_FECHAMENTOS_CAIXAS_MANUTENCOES_SOBRAS   D WITH(NOLOCK)ON D.REGISTRO  = B.FECHAMENTO_CAIXA
 WHERE
     A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
 AND ISNULL(B.SOBRA_CAIXA,0)         > 0

     UNION ALL
   
 --CAIXAS QUE POSSUIAM QUEBRA DE CAIXA--
 SELECT
     1                                              AS TIPO_FINALIZADORA
    ,CASE WHEN ISNULL(SUM(D.VALOR_JUSTIFICAVEL),0) > ISNULL(SUM(D.VALOR_FALTA),0)
          THEN ISNULL(SUM(D.VALOR_JUSTIFICAVEL),0) - ISNULL(SUM(D.VALOR_FALTA),0)
          ELSE 0 
     END                                            AS VALOR
 FROM
     CONFERENCIAS_FECHAMENTOS_CAIXAS            A WITH(NOLOCK)
 JOIN
     FECHAMENTOS_CAIXAS                         B WITH(NOLOCK)ON B.EMPRESA   = A.EMPRESA
                                                             AND B.MOVIMENTO = A.MOVIMENTO
 LEFT JOIN
     DL_FECHAMENTOS_CAIXAS_MANUTENCOES_FALTAS   D WITH(NOLOCK) ON D.REGISTRO  = B.FECHAMENTO_CAIXA
 WHERE
     A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
  AND ISNULL(D.VALOR_JUSTIFICAVEL,0) - ISNULL(D.VALOR_FALTA,0) > 0
) X
GROUP BY
    X.TIPO_FINALIZADORA
   
   
   -----------------------------
   -- GERA TABELA DE RECARGAS --
   -----------------------------
   SELECT CASE WHEN LEFT(B.TIPO_PAGAMENTO,2) = '00' THEN 2 -- 00 - Cheque
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '01' THEN 4 -- 01 - Cartão de Débito
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '02' THEN 4 -- 02 - Cartão de Crédito
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '03' THEN 4 -- 03 - Cartão tipo Voucher
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '98' THEN 1 -- 98 - Dinheiro 
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '99' THEN 1 -- 99 - Outro tipo de cartão 
          END             AS TIPO_FINALIZADORA,
          SUM(B.VALOR_RECARGA) AS VALOR_RECARGA
     INTO #RECARGAS
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_RECARGAS                        B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                           AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
    GROUP BY
          CASE WHEN LEFT(B.TIPO_PAGAMENTO,2) = '00' THEN 2 -- 00 - Cheque
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '01' THEN 4 -- 01 - Cartão de Débito
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '02' THEN 4 -- 02 - Cartão de Crédito
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '03' THEN 4 -- 03 - Cartão tipo Voucher
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '98' THEN 1 -- 98 - Dinheiro 
               WHEN LEFT(B.TIPO_PAGAMENTO,2) = '99' THEN 1 -- 99 - Outro tipo de cartão 
          END


   ---------------------------------
   -- GERA TABELA DE RECEBIMENTOS --
   ---------------------------------
   SELECT B.TIPO               AS TIPO_FINALIZADORA ,
          SUM(B.VALOR-B.TROCO) AS VALOR_RECEBIMENTO
     INTO #RECEBTOS
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN PDV_RECEBIMENTOS_FINALIZADORAS  B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                       AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
    GROUP BY
          B.TIPO

   UNION ALL

   SELECT B.TIPO               AS TIPO_FINALIZADORA ,
          SUM(B.VALOR-B.TROCO) AS VALOR_RECEBIMENTO
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS         A WITH(NOLOCK)
     JOIN PDV_RECEBIMENTOS_SERVICOS_FINALIZADORAS B WITH(NOLOCK)ON B.LOJA      = A.EMPRESA
                                                               AND B.MOVIMENTO = A.MOVIMENTO
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
    GROUP BY
          B.TIPO

   ----------------------------------------------
   -- GERA TABELA COM VALOR DAS DEVOLUCOES --
   ----------------------------------------------
   SELECT 1                                 AS TIPO_FINALIZADORA ,
          ISNULL(SUM(C.VALOR_DEVOLVIDO ),0) AS VALOR_DEVOLVIDO 
     INTO #DEVOLUCOES
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN DEV_DINHEIRO_CAIXAS             B WITH(NOLOCK)ON B.EMPRESA            = A.EMPRESA
                                                       AND B.MOVIMENTO          = A.MOVIMENTO
     JOIN DEV_DINHEIRO_TOTAIS             C WITH(NOLOCK)ON C.DEVOLUCAO_DINHEIRO = B.DEVOLUCAO_DINHEIRO 
                                                       
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND ISNULL(C.VALOR_DEVOLVIDO,0)      > 0


   -----------------------------
   -- INSERE NA TABELA FÍSICA --
   ----------------------------- 
    INSERT 
      INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_FINALIZADORAS
          (
           FORMULARIO_ORIGEM            ,
           TAB_MASTER_ORIGEM            ,
           REG_MASTER_ORIGEM            ,
           REG_LOG_INCLUSAO             ,
           CONFERENCIA_FECHAMENTO_CAIXA ,
           TIPO_FINALIZADORA            ,
           QTD_CUPONS                   ,
           ENTRADA                      ,
           TROCO_INICIAL                ,
           SUPRIMENTO                   ,
           PBM                          ,
           RECARGA                      ,
           RECEBIMENTO                  ,
           VALE_FUNCIONARIO             ,
           SOBRA_CAIXA                  ,
           SANGRIA                      ,
           CONTAGEM                     ,
           QUEBRA_CAIXA_PERMITIDA       ,
           DIFERENCA                    ,
           DEVOLUCAO                    ,
           TROCO_ENTRADA                ,
           TROCO_SAIDA                    
          )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.TIPO                         AS TIPO_FINALIZADORA            ,
          ISNULL(C.QTD_CUPONS       ,0)  AS QTD_CUPONS                   ,
          ISNULL(C.VALOR_ENTRADAS   ,0)  -                                -- MATHIAS - 2017 01 26 - o recebimento em TEF/POS já vem na função "PDV_VENDAS_FECHAMENTOS_CAIXAS"
          CASE WHEN B.TIPO IN ( 4 , 9 )                                   --                      - por isso ele precisa ser estornado do valor da entrada
               THEN ISNULL(G.VALOR_RECEBIMENTO,0)                         --                      - não fiz a alteração da função pois ela é utilizada em outros lugares e isso
               ELSE 0                                                     --                      - poderia gerar outros problemas.
          END                            AS ENTRADA                      , 
          ISNULL(H.VALOR            ,0)  AS TROCO_INICIAL                ,
          ISNULL(K.VALOR            ,0)  AS SUPRIMENTO                   ,
          ISNULL(C.VALOR_PBM        ,0)  AS PBM                          ,
          ISNULL(F.VALOR_RECARGA    ,0)  AS RECARGAS                     ,
          ISNULL(G.VALOR_RECEBIMENTO,0)  AS RECEBIMENTO                  ,
          ISNULL(I.VALOR_VALE       ,0)  AS VALE_FUNCIONARIO             ,
          ISNULL(J.VALOR            ,0)  AS SOBRA_CAIXA                  ,
          ISNULL(D.VALOR            ,0)  AS SANGRIA                      ,
          ISNULL(E.VALOR            ,0)  AS CONTAGEM                     ,

          ISNULL(I.VALOR_PERMITIDO  ,0)  AS QUEBRA_CAIXA_PERMITIDA       ,

         (ISNULL(D.VALOR            ,0)  +
          ISNULL(E.VALOR            ,0)  +
          ISNULL(I.VALOR_VALE       ,0)  +
          ISNULL(I.VALOR_PERMITIDO  ,0)) -

         (ISNULL(C.VALOR_ENTRADAS   ,0)  +
          ISNULL(H.VALOR            ,0)  + 
          ISNULL(K.VALOR            ,0)  +
          ISNULL(C.VALOR_PBM        ,0)  +
          ISNULL(F.VALOR_RECARGA    ,0)  +
          ISNULL(G.VALOR_RECEBIMENTO,0)  +
          --ISNULL(J.VALOR            ,0)) AS DIFERENCA                   ,
          --ISNULL(L.VALOR_DEVOLVIDO  ,0)  AS DEVOLUCAO
          ISNULL(J.VALOR            ,0)  -
          CASE WHEN B.TIPO IN ( 4 , 9 ) 
               THEN ISNULL(G.VALOR_RECEBIMENTO,0)
               ELSE 0
          END) -
         (ISNULL(H.TROCO_ENTRADA    ,0) -
          ISNULL(H.TROCO_SAIDA      ,0)) AS DIFERENCA                    ,

          ISNULL(L.VALOR_DEVOLVIDO  ,0)  AS DEVOLUCAO                    ,
          ISNULL(H.TROCO_ENTRADA    ,0)  AS TROCO_ENTRADA                ,
          ISNULL(H.TROCO_SAIDA      ,0)  AS TROCO_SAIDA                              

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)
     JOIN TIPOS_FINALIZADORAS             B WITH(NOLOCK)ON 1=1
     LEFT
     JOIN #ENTRADAS                       C WITH(NOLOCK)ON C.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #SANGRIAS                       D WITH(NOLOCK)ON D.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #CONTAGEM                       E WITH(NOLOCK)ON E.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #RECARGAS                       F WITH(NOLOCK)ON F.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #RECEBTOS                       G WITH(NOLOCK)ON G.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #TROCO_INICIAL                  H WITH(NOLOCK)ON H.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #QUEBRA_CAIXA                   I WITH(NOLOCK)ON I.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #SOBRA_CAIXA                    J WITH(NOLOCK)ON J.TIPO_FINALIZADORA = B.TIPO
    
     LEFT
     JOIN #SUPRIMENTOS                    K WITH(NOLOCK)ON K.TIPO_FINALIZADORA = B.TIPO
     LEFT
     JOIN #DEVOLUCOES                     L WITH(NOLOCK)ON L.TIPO_FINALIZADORA = B.TIPO

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA

    ORDER BY
          TIPO_FINALIZADORA


PRINT '---------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A ENVIOS    --'
PRINT '---------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          DEPOSITO_LOJA                ,
          DATA_HORA                    ,
          MOVIMENTO                    ,
          ENVIO_DINHEIRO               ,
          ENVIO_CHEQUE                 ,
          ENVIO_CHEQUE_PREDATADO       ,
          CONFERIDO                     
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.DEPOSITO_LOJA                AS DEPOSITO_LOJA                ,
          B.DATA_HORA                    AS DATA_HORA                    ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.DEPOSITO_DINHEIRO            AS ENVIO_DINHEIRO               ,
          B.ENVIO_CHEQUE                 AS ENVIO_CHEQUE                 ,
          B.ENVIO_PREDATADOS             AS ENVIO_CHEQUE_PREDATADO       ,
          --CASE WHEN E.COFRE_LANCAMENTO IS NOT NULL 
          --     THEN 'S'
          --     ELSE 'N' END              AS CONFERIDO  
          'S'                            AS CONFERIDO                   
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS        A WITH(NOLOCK)
     JOIN DEPOSITOS_LOJAS                        B WITH(NOLOCK)ON B.EMPRESA       = A.EMPRESA
                                                              AND B.MOVIMENTO     = @MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS C WITH(NOLOCK)ON C.DEPOSITO_LOJA = B.DEPOSITO_LOJA
     --LEFT
     --JOIN COFRES_LOJAS_LANCAMENTOS               D WITH(NOLOCK)ON D.FORMULARIO_ORIGEM = B.FORMULARIO_ORIGEM
     --                                                         AND D.TAB_MASTER_ORIGEM = B.TAB_MASTER_ORIGEM
     --                                                         AND D.REG_MASTER_ORIGEM = B.DEPOSITO_LOJA
     --LEFT
     --JOIN CAIXA_RECEBIMENTOS_DINHEIRO            E WITH(NOLOCK)ON E.COFRE_LANCAMENTO  = D.COFRE_LANCAMENTO

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.PROCESSAR                     = 'S'

    ORDER BY
          MOVIMENTO 
PRINT '--------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A DEPÓSITO EM DINHEIRO --'
PRINT '--------------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          DEPOSITO_LOJA                ,
          DATA_HORA                    ,
          MOVIMENTO                    ,
          DEPOSITO_DINHEIRO            ,
          CONTA_BANCARIA               ,
          NUMERO_DOCUMENTO             ,
          CONFERIDO                    ,
          DATA_COMPENSACAO             ,
          TIPO_DEPOSITO_COFRE
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.DEPOSITO_LOJA                AS DEPOSITO_LOJA                ,
          B.DATA_HORA                    AS DATA_HORA                    ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.DEPOSITO_DINHEIRO            AS DEPOSITO_DINHEIRO            ,
          B.CONTA_BANCARIA               AS CONTA_BANCARIA               ,
          ISNULL(B.NUMERO_DOCUMENTO,'')  AS NUMERO_DOCUMENTO             ,
          'N'                            AS CONFERIDO                    ,
          B.DATA_COMPENSACAO             AS DATA_COMPENSACAO             ,
          B.TIPO_DEPOSITO_COFRE          AS TIPO_DEPOSITO_COFRE

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS              A WITH(NOLOCK)
     JOIN DEPOSITOS_BANCARIOS_LOJAS_DINH               B WITH(NOLOCK)ON B.EMPRESA       = A.EMPRESA
                                                                    AND B.MOVIMENTO     = @MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO C WITH(NOLOCK)ON C.DEPOSITO_LOJA = B.DEPOSITO_LOJA

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.CONFIRMAR_DEPOSITO            = 'S'
    ORDER BY
          MOVIMENTO 

PRINT '-------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A DEPÓSITO EM CHEQUES --'
PRINT '-------------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          DEPOSITO_LOJA                ,
          DATA_HORA                    ,
          MOVIMENTO                    ,
          DEPOSITO_CHEQUE              ,
          CONTA_BANCARIA               ,
          NUMERO_DOCUMENTO             ,
          CONFERIDO                    ,
          DATA_COMPENSACAO                    
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.DEPOSITO_LOJA                AS DEPOSITO_LOJA                ,
          B.DATA_HORA                    AS DATA_HORA                    ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.DEPOSITO_CHEQUE              AS DEPOSITO_CHEQUE              ,
          B.CONTA_BANCARIA               AS CONTA_BANCARIA               ,
          ISNULL(B.NUMERO_DOCUMENTO,'')  AS NUMERO_DOCUMENTO             ,
          'N'                            AS CONFERIDO                    ,
          B.DATA_COMPENSACAO             AS DATA_COMPENSACAO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS              A WITH(NOLOCK)
     JOIN DEPOSITOS_BANCARIOS_LOJAS                    B WITH(NOLOCK)ON B.EMPRESA       = A.EMPRESA
                                                                    AND B.MOVIMENTO     = @MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES  C WITH(NOLOCK)ON C.DEPOSITO_LOJA = B.DEPOSITO_LOJA

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.CONFIRMAR_DEPOSITO            = 'S'

    ORDER BY
          MOVIMENTO 


PRINT '---------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A TEF       --'
PRINT '---------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          MOVIMENTO                    ,
          VENDA                        ,
          ECF_CUPOM                    ,
          BANDEIRA                     ,
          ADQUIRENTE_ID                ,
          ADQUIRENTE                   ,
          CODBANDEIRA                  ,
          TIPO                         ,
          PARCELAS                     ,
          NSU                          ,
          AUTORIZACAO_TEF              ,
          VALOR                        ,
          ORIGEM                       ,
          CONFERIDO                    ,
          ADMINISTRADORA_CARTAO_BANDEIRA                    
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          X.LOJA                         AS LOJA                         ,
          X.CAIXA                        AS CAIXA                        ,
          X.MOVIMENTO                    AS MOVIMENTO                    ,
          X.VENDA                        AS VENDA                        ,
          X.ECF_CUPOM                    AS ECF_CUPOM                    ,
          D.ADQUIRENTE                   AS BANDEIRA                     ,
          D.ADQUIRENTE_ID                AS ADQUIRENTE_ID                 , --GRAVAÇÃO DA INFORMAÇÃO DE ADQUIRENTE_ID NA TABELA, ANDERSON SILVA 09/03/2022
          D.ADQUIRENTE                   AS ADQUIRENTE                   ,
          X.CODBANDEIRA                  AS CODBANDEIRA                  ,
          CASE WHEN LEFT(X.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                            AS TIPO                         ,
          --X.TIPO_BANDEIRA                AS TIPO                         ,
          DBO.ISZERO(X.PARCELAS,1)       AS PARCELAS                     ,
          RIGHT(ISNULL(X.NSU,''),10)     AS NSU                          ,
          ISNULL(X.AUTORIZACAO_TEF,'')   AS AUTORIZACAO_TEF              , -- MATHIAS - ATUALMENTE NÃO TEM ESTA INFORMAÇÃO NO PDV
          X.VALOR                        AS VALOR                        ,
          X.ORIGEM                       AS ORIGEM                       ,
          --'S'                            AS CONFERIDO                    ,
          'N'                            AS CONFERIDO                    , --006
          X.ADMINISTRADORA_CARTAO_BANDEIRA AS ADMINISTRADORA_CARTAO_BANDEIRA
                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS          A WITH(NOLOCK)
     JOIN #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS X ON X.CONFERENCIA_FECHAMENTO_CAIXA       = A.CONFERENCIA_FECHAMENTO_CAIXA
     --JOIN PDV_VENDAS_FECHAMENTOS_CAIXAS ( @MOVIMENTO ,
     --                                     @MOVIMENTO ,
     --                                     @EMPRESA ,
     --                                     @EMPRESA ) X ON 0 = 0

     --JOIN VENDAS_TEF_POS                      X WITH(NOLOCK)ON X.EMPRESA             = A.EMPRESA
     --                                                      AND X.MOVIMENTO           = @MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF C WITH(NOLOCK)ON C.LOJA                = X.LOJA
                                                           AND C.MOVIMENTO           = X.MOVIMENTO
                                                           AND C.CAIXA               = X.CAIXA
                                                           AND C.VENDA               = X.VENDA
     --LEFT -- MATHIAS - DEIXEI O LEFT PARA TRAZER O QUE NÃO FOR IDENTIFICADO TAMBÉM
     --JOIN BANDEIRAS_CARTOES                   D WITH(NOLOCK)ON D.CODIGO_BANDEIRA_PDV = X.BANDEIRA    -- MATHIAS - MARCELO VAI REVER ESTAS INFORMAÇÕES COM A THAIANE
     --                                                      AND D.CODBANDEIRA         = X.CODBANDEIRA
     --                                                      AND ISNULL(D.PARCELAS, 1) = DBO.ISZERO(X.PARCELAS ,1)
LEFT JOIN ADQUIRENTES                              D WITH(NOLOCK) ON D.ADQUIRENTE      = RIGHT(X.BANDEIRA,5)

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND X.TIPO             = 4

/*
   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,

          B.BANDEIRA                     AS BANDEIRA                     ,

          CASE WHEN ISNUMERIC(B.CODBANDEIRA) = 1
               THEN B.CODBANDEIRA
               ELSE NULL
          END                            AS CODBANDEIRA                  ,

          CASE WHEN LEFT(B.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                            AS TIPO                         ,

          B.PARCELAS                     AS PARCELAS                     ,
          B.NSU                          AS NSU                          ,
          B.AUTORIZACAO_TEF              AS AUTORIZACAO_TEF              ,

          CASE WHEN X.STATUS = 'A' 
               THEN CASE WHEN B.STATUS = 'A' 
                         THEN ( B.VALOR - B.TROCO )
                         ELSE ( B.VALOR - B.TROCO ) * (-1) 
                    END 
               ELSE 0 
          END                            AS VALOR                        ,

          'S'                            AS CONFERIDO                    --AGATHA 09/06/2016 -- PEDIDO DO CONSULTOR GABRIEL

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_VENDAS                          X WITH(NOLOCK)ON X.EMPRESA             = A.EMPRESA
                                                           AND X.MOVIMENTO           = @MOVIMENTO
     JOIN PDV_FINALIZADORAS                   B WITH(NOLOCK)ON B.LOJA                = X.LOJA
                                                           AND B.MOVIMENTO           = X.MOVIMENTO
                                                           AND B.VENDA               = X.VENDA
                                                           AND B.CAIXA               = X.CAIXA
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF C WITH(NOLOCK)ON C.LOJA                = B.LOJA
                                                           AND C.MOVIMENTO           = B.MOVIMENTO
                                                           AND C.CAIXA               = B.CAIXA
                                                           AND C.VENDA               = B.VENDA
     LEFT -- MATHIAS - DEIXEI O LEFT PARA TRAZER O QUE NÃO FOR IDENTIFICADO TAMBÉM
     JOIN BANDEIRAS_CARTOES                   D WITH(NOLOCK)ON D.CODIGO_BANDEIRA_PDV = B.BANDEIRA
                                                           AND D.CODBANDEIRA         = B.CODBANDEIRA
                                                           AND D.PARCELAS            = B.PARCELAS

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 4

    ORDER BY
          MOVIMENTO ,
          CAIXA      
*/
   -----------------------------------------------------------------------------------------------
   -- ATUALIZA O CAMPO CONFERIDO DE ACORDO COM O ARQUIVO IMPORTADO DA ADMINISTRADORA DE CARTÕES --
   -----------------------------------------------------------------------------------------------
   -- NECESSÁRIO PARA EVITAR PROBLEMAS DE LOCK ENTRE USUÁRIOS
   IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF_UPDATE' ) IS NOT NULL DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF_UPDATE

   SELECT B.CONFERENCIA_FECHAMENTO_CAIXA_TEF
     INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF_UPDATE
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK) 
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF B WITH(NOLOCK)ON B.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
     JOIN CIELO_RETORNO_DETALHE_CV            C WITH(NOLOCK)ON C.CODIGO_AUTORIZACAO           = B.AUTORIZACAO_TEF
                                                           AND C.NSU                          = RIGHT(B.NSU,6)
                                                           AND B.VALOR                        = CASE WHEN PARCELAS > 0 THEN C.VALOR_TOTAL_VENDA_CASO_PARCELADO_LOJA
                                                                                                                       ELSE C.VALOR_COMPRA
                                                                                                END
     JOIN CIELO_RETORNO_HEADER                D WITH(NOLOCK)ON D.CIELO_RETORNO                = C.CIELO_RETORNO
                                                           AND D.OPCAO_EXTRATO               IN ( '01', '02', '03' ) -- EXTRATOS REFERENTE A VENDAS
     JOIN CIELO_RETORNO                       E WITH(NOLOCK)ON E.CIELO_RETORNO                = D.CIELO_RETORNO
     JOIN ADMINISTRADORAS_CARTOES             F WITH(NOLOCK)ON F.ADMINISTRADORA_CARTAO        = E.ADMINISTRADORA_CARTAO
                                                           AND F.ADQUIRENTE                   = RIGHT(B.BANDEIRA,5) -- BANDEIRA É O ADQUIRENTE SÓ QUE ESTÁ COM O NOME ERRADO

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA

   UPDATE CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF
      SET CONFERIDO = 'S'
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF         A WITH(NOLOCK) 
     JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF_UPDATE B WITH(NOLOCK)ON B.CONFERENCIA_FECHAMENTO_CAIXA_TEF = A.CONFERENCIA_FECHAMENTO_CAIXA_TEF

PRINT '---------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A POS       --'
PRINT '---------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_POS
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          MOVIMENTO                    ,
          VENDA                        ,
          ECF_CUPOM                    ,
          ADQUIRENTE_ID                ,
          BANDEIRA                     ,
          ADQUIRENTE                   ,
          CODBANDEIRA                  ,
          TIPO                         ,
          PARCELAS                     ,
          NSU                          ,
          AUTORIZACAO_POS              ,
          VALOR                        ,
          CONFERIDO                    ,
          ADMINISTRADORA_CARTAO_BANDEIRA,
          VENDEDOR
         )

-- 2017 06 30 - MATHIAS - O PRIMEIRO SELECT TRATA APENAS VENDAS DO PDV, POIS DA UM JOIN COM A PDV_VENDAS_STATUS PARA TRAZER APENAS O STATUS 'A'
--                      - AS OUTRAS ORIGENS NÃO TEM PDV POR ISSO PRECISA SER SEPARADO
--                      - O SEGUNDO SELECT TRATA TODAS AS DEMAIS ORIGENS
SELECT A.FORMULARIO_ORIGEM                  AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM                  AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA       AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO                   AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA       AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                               AS LOJA                         ,
          B.CAIXA                              AS CAIXA                        ,
          B.MOVIMENTO                          AS MOVIMENTO                    ,
          B.VENDA                              AS VENDA                        ,
          B.ECF_CUPOM                          AS ECF_CUPOM                    ,
          D.ADQUIRENTE_ID                      AS ADQUIRENTE_ID                ,  --GRAVAÇÃO DA INFORMAÇÃO DE ADQUIRENTE_ID NA TABELA, ANDERSON SILVA 09/03/2022
          D.ADQUIRENTE                         AS BANDEIRA                     ,
          D.ADQUIRENTE                         AS ADQUIRENTE                   ,
          B.CODBANDEIRA                        AS CODBANDEIRA                  ,
          --B.TIPO_BANDEIRA                      AS TIPO                         ,
          CASE WHEN LEFT(B.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                            AS TIPO                         ,
          CASE 
              WHEN ISNULL(B.PARCELAS,0) = 0 
              THEN 1 
              ELSE B.PARCELAS 
          END                                  AS PARCELAS                     ,
          B.NSU                                AS NSU                          ,
          NULL                                 AS AUTORIZACAO_POS              , -- MATHIAS - ATUALMENTE NÃO TEM ESTA INFORMAÇÃO NO PDV
          B.VALOR                              AS VALOR      ,
          'N'                                  AS CONFERIDO ,
          ISNULL(B.ADMINISTRADORA_CARTAO_BANDEIRA,0)     AS ADMINISTRADORA_CARTAO_BANDEIRA,
          B.VENDEDOR                           AS VENDEDOR

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS              A WITH(NOLOCK)
     JOIN #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS     B ON B.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
     JOIN PDV_VENDAS_STATUS                            X WITH(NOLOCK) ON X.VENDA           = B.VENDA_ORIGINAL
                                                                     AND X.LOJA            = B.LOJA_ORIGINAL
                                                                     AND X.CAIXA           = B.CAIXA_ORIGINAL
                                                                     AND X.MOVIMENTO       = B.MOVIMENTO_ORIGINAL
                                                                     AND X.STATUS          = 'A' -- POR CAUSA DO RECEBIMENTO DE TITULOS, RECARGAS E SERVICOS QUE NÃO TEM PDV_VENDAS
LEFT JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_POS          C WITH(NOLOCK) ON C.LOJA            = B.LOJA
                                                                     AND C.MOVIMENTO       = B.MOVIMENTO
                                                                     AND C.CAIXA           = B.CAIXA
                                                                     AND C.VENDA           = B.VENDA
                                                                     AND C.CODBANDEIRA      = B.CODBANDEIRA
LEFT JOIN ADQUIRENTES                                  D WITH(NOLOCK) ON D.ADQUIRENTE      = RIGHT(B.BANDEIRA,5)

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 9
      AND B.ORIGEM_CONTROLE               = 1

   UNION ALL

   SELECT A.FORMULARIO_ORIGEM                  AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM                  AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA       AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO                   AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA       AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                               AS LOJA                         ,
          B.CAIXA                              AS CAIXA                        ,
          B.MOVIMENTO                          AS MOVIMENTO                    ,
          B.VENDA                              AS VENDA                        ,
          B.ECF_CUPOM                          AS ECF_CUPOM                    ,
          D.ADQUIRENTE_ID                      AS ADQUIRENTE_ID                ,
          D.ADQUIRENTE                         AS BANDEIRA                     ,
          D.ADQUIRENTE                         AS ADQUIRENTE                   ,
          B.CODBANDEIRA                        AS CODBANDEIRA                  ,
          --B.TIPO_BANDEIRA                      AS TIPO                         ,
          CASE WHEN LEFT(B.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                            AS TIPO                         ,
          CASE 
             WHEN ISNULL(B.PARCELAS,0) = 0 
             THEN 1 
             ELSE B.PARCELAS 
          END                                  AS PARCELAS                     ,
          B.NSU                                AS NSU                          ,
          NULL                                 AS AUTORIZACAO_POS              , -- MATHIAS - ATUALMENTE NÃO TEM ESTA INFORMAÇÃO NO PDV
          B.VALOR                              AS VALOR      ,
          'N'                                  AS CONFERIDO  ,
          ISNULL(B.ADMINISTRADORA_CARTAO_BANDEIRA,0)     AS ADMINISTRADORA_CARTAO_BANDEIRA,
          B.VENDEDOR                           AS VENDEDOR
          
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS              A WITH(NOLOCK)
     JOIN #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS     B ON B.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
LEFT JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_POS          C WITH(NOLOCK)ON C.LOJA             = B.LOJA
                                                                    AND C.MOVIMENTO        = B.MOVIMENTO
                                                                    AND C.CAIXA            = B.CAIXA
                                                                    AND C.VENDA            = B.VENDA
LEFT JOIN ADQUIRENTES                                  D WITH(NOLOCK) ON D.ADQUIRENTE      = RIGHT(B.BANDEIRA,5)


    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 9
      AND B.ORIGEM_CONTROLE              <> 1

--WILLYAN 24/01/2018 - EM ATUALIZAÇÃO SEGUINDO A BASE DA NISSEI, TODO ESSA PASSAGEM FOI SUBSTITUIDA PELO CÓDIGO ACIMA
/*
-- MATHIAS - ATÉ O DIA 10/07/2014 NA CONDE O PDV NAO GRAVAVA AS INFORMAÇÕES DE BANDEIRA CORRETAMENTE POR ISSO ESTA ROTINA FICOU ASSIM
--         - A ROTINA CORRETA QUE VALE A PARTIR DESTA DATA ESTÁ LOGO ABAIXO
   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,

          NULL                           AS BANDEIRA                     , -- MATHIAS - MARCELO VAI ALINHAR COM THAIANE SOBRE PREENCHIMENTO DESTAS INFORMAÇÕES

          CASE WHEN ISNUMERIC(B.BANDEIRA) = 1
               THEN RIGHT(B.BANDEIRA,5)
               ELSE NULL
          END                            AS CODBANDEIRA                  ,

          CASE WHEN LEFT(B.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                            AS TIPO                         ,

          B.PARCELAS                     AS PARCELAS                     ,
          B.NSU                          AS NSU                          ,
          NULL                           AS AUTORIZACAO_POS              , -- MATHIAS - ATUALMENTE NÃO TEM ESTA INFORMAÇÃO NO PDV

          CASE WHEN X.STATUS = 'A' 
               THEN CASE WHEN B.STATUS = 'A' 
                         THEN ( B.VALOR - B.TROCO )
                         ELSE ( B.VALOR - B.TROCO ) * (-1) 
                    END 
               ELSE 0 
          END                            AS VALOR                        ,

          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_VENDAS                          X WITH(NOLOCK)ON X.EMPRESA             = A.EMPRESA
                                                           AND X.MOVIMENTO           = @MOVIMENTO
     JOIN PDV_FINALIZADORAS                   B WITH(NOLOCK)ON B.LOJA                = X.LOJA
                                                           AND B.MOVIMENTO           = X.MOVIMENTO
                                                           AND B.VENDA               = X.VENDA
                                                           AND B.CAIXA               = X.CAIXA
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_POS C WITH(NOLOCK)ON C.LOJA                = B.LOJA
                                                           AND C.MOVIMENTO           = B.MOVIMENTO
                                                           AND C.CAIXA               = B.CAIXA
                                                           AND C.VENDA               = B.VENDA
     LEFT -- MATHIAS - DEIXEI O LEFT PARA TRAZER O QUE NÃO FOR IDENTIFICADO TAMBÉM
     JOIN BANDEIRAS_CARTOES                   D WITH(NOLOCK)ON D.CODIGO_BANDEIRA_POS = B.BANDEIRA    -- MATHIAS - MARCELO VAI REVER ESTAS INFORMAÇÕES COM A THAIANE
                                                           AND D.CODBANDEIRA         = B.CODBANDEIRA
                                                           AND D.PARCELAS            = B.PARCELAS

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 9
      AND B.MOVIMENTO                     < '11/07/2014' -- VER OBSERVAÇÃO NO INÍCIO DA SELECT

    UNION ALL

-- MATHIAS - ATÉ O DIA 10/07/2014 NA CONDE O PDV NAO GRAVAVA AS INFORMAÇÕES DE BANDEIRA CORRETAMENTE POR ISSO ESTA ROTINA FICOU ASSIM
--         - ROTINA CORRETA A PARTIR DE 11/07/2014
   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,

          B.BANDEIRA                     AS BANDEIRA                     ,

          CASE WHEN ISNUMERIC(B.CODBANDEIRA) = 1
               THEN B.CODBANDEIRA
               ELSE NULL
          END                            AS CODBANDEIRA                  ,

          CASE WHEN LEFT(B.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                            AS TIPO                         ,

          B.PARCELAS                     AS PARCELAS                     ,
          B.NSU                          AS NSU                          ,
          NULL                           AS AUTORIZACAO_POS              , -- MATHIAS - ATUALMENTE NÃO TEM ESTA INFORMAÇÃO NO PDV

          CASE WHEN X.STATUS = 'A' 
               THEN CASE WHEN B.STATUS = 'A' 
                         THEN ( B.VALOR - B.TROCO )
                         ELSE ( B.VALOR - B.TROCO ) * (-1) 
                    END 
               ELSE 0 
          END                            AS VALOR                        ,

          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_VENDAS                          X WITH(NOLOCK)ON X.EMPRESA             = A.EMPRESA
                                                           AND X.MOVIMENTO           = @MOVIMENTO
     JOIN PDV_FINALIZADORAS                   B WITH(NOLOCK)ON B.LOJA                = X.LOJA
                                                           AND B.MOVIMENTO           = X.MOVIMENTO
                                                           AND B.VENDA               = X.VENDA
                                                           AND B.CAIXA               = X.CAIXA
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_POS C WITH(NOLOCK)ON C.LOJA                = B.LOJA
                                                           AND C.MOVIMENTO           = B.MOVIMENTO
                                                           AND C.CAIXA               = B.CAIXA
                                                           AND C.VENDA               = B.VENDA
     LEFT -- MATHIAS - DEIXEI O LEFT PARA TRAZER O QUE NÃO FOR IDENTIFICADO TAMBÉM
     JOIN BANDEIRAS_CARTOES                   D WITH(NOLOCK)ON D.CODIGO_BANDEIRA_POS = B.BANDEIRA    -- MATHIAS - MARCELO VAI REVER ESTAS INFORMAÇÕES COM A THAIANE
                                                           AND D.CODBANDEIRA         = B.CODBANDEIRA
                                                           AND D.PARCELAS            = B.PARCELAS

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 9
      AND B.MOVIMENTO                    >= '11/07/2014' -- VER OBSERVAÇÃO NO INÍCIO DA SELECT

    UNION ALL

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.RECEBIMENTO_FINALIZADORA     AS VENDA                        ,
          NULL                           AS ECF_CUPOM                    ,
          B.BANDEIRA                     AS BANDEIRA                     ,
          NULL                           AS CODBANDEIRA                  ,
          CASE WHEN LEFT(B.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                            AS TIPO                         ,
          B.PARCELAS                     AS PARCELAS                     ,
          NULL                           AS NSU                          ,
          NULL                           AS AUTORIZACAO_POS              ,
          B.VALOR - B.TROCO              AS VALOR                        ,
          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS     A WITH(NOLOCK)
     JOIN PDV_RECEBIMENTOS_FINALIZADORAS      B WITH(NOLOCK)ON B.LOJA                = A.EMPRESA
                                                           AND B.MOVIMENTO           = @MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_POS C WITH(NOLOCK)ON C.LOJA                = B.LOJA
                                                           AND C.MOVIMENTO           = B.MOVIMENTO
                                                           AND C.CAIXA               = B.CAIXA
                                                           AND C.VENDA               = B.RECEBIMENTO_FINALIZADORA

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 9

    UNION ALL

   SELECT A.FORMULARIO_ORIGEM                AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM                AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA     AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO                 AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA     AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                             AS LOJA                         ,
          B.CAIXA                            AS CAIXA                        ,
          B.MOVIMENTO                        AS MOVIMENTO                    ,
          B.RECEBIMENTO_SERVICO_FINALIZADORA AS VENDA                        ,
          NULL                               AS ECF_CUPOM                    ,
          B.BANDEIRA                         AS BANDEIRA                     ,
          NULL                               AS CODBANDEIRA                  ,
          CASE WHEN LEFT(B.BANDEIRA,2) = '01'
               THEN 'D'
               ELSE 'C'
          END                                AS TIPO                         ,
          NULL                               AS PARCELAS                     ,
          NULL                               AS NSU                          ,
          NULL                               AS AUTORIZACAO_POS              ,
          B.VALOR - B.TROCO                  AS VALOR                        ,
          'N'                                AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS         A WITH(NOLOCK)
     JOIN PDV_RECEBIMENTOS_SERVICOS_FINALIZADORAS B WITH(NOLOCK)ON B.LOJA                = A.EMPRESA
                                                               AND B.MOVIMENTO           = @MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_POS     C WITH(NOLOCK)ON C.LOJA                = B.LOJA
                                                               AND C.MOVIMENTO           = B.MOVIMENTO
                                                               AND C.CAIXA               = B.CAIXA
                                                               AND C.VENDA               = B.RECEBIMENTO_SERVICO_FINALIZADORA

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 9

    ORDER BY
          MOVIMENTO ,
          CAIXA      
*/

PRINT '---------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A CONVENIOS --'
PRINT '---------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          MOVIMENTO                    ,
          VENDA                        ,
          ECF_CUPOM                    ,
          CONVENIO_CARTAO              ,
          NOME                         ,
          CODIGO_CONVENIO              ,
          PARCELAS                     ,
          VALOR                        ,
          CONFERIDO                    
         )

   SELECT DISTINCT -- 2017 01 31 - MATHIAS - FOI NECESSÁRIO POR CAUSA DE CONFERÊNCIAS JÁ PROCESSADAS QUE NÃO PODEM SER REABERTAS
                   --                      - ISSO ACONTECEU POR UMA FALHA NO CONTROLE NAS DATAS DE VENDA E DATA DE RETORNO DO ENTREGADOR
          A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,
          B.CLIENTE                      AS CONVENIO_CARTAO              ,
          D.NOME                         AS NOME                         ,
          E.ENTIDADE                     AS CODIGO_CONVENIO              ,
          --B.PARCELAS                   AS PARCELAS                     ,
          ISNULL(B.PARCELAS,1)           AS PARCELAS                     ,
          B.VALOR                        AS VALOR                        ,
          CASE WHEN F.CONVENIO_CONFERENCIA_CUPOM IS NOT NULL
               THEN 'S'             
               ELSE 'N'
          END                            AS CONFERIDO
          --CASE WHEN X.STATUS = 'A' 
          --     THEN CASE WHEN B.STATUS = 'A' 
          --               THEN ( B.VALOR - B.TROCO )
          --               ELSE ( B.VALOR - B.TROCO ) * (-1) 
          --          END 
          --     ELSE 0 
          --END                            AS VALOR                        ,

          --'S'                            AS CONFERIDO    --AGATHA 09/06/2016 -- PEDIDO DO CONSULTOR GABRIEL                 

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS           A WITH(NOLOCK)
     --JOIN PDV_VENDAS                                X WITH(NOLOCK)ON X.EMPRESA         = A.EMPRESA
     --                                                            AND X.MOVIMENTO       = @MOVIMENTO
     --JOIN PDV_FINALIZADORAS                         B WITH(NOLOCK)ON B.LOJA            = X.LOJA
     --                                                            AND B.MOVIMENTO       = X.MOVIMENTO
     --                                                            AND B.VENDA           = X.VENDA
     --                                                            AND B.CAIXA           = X.CAIXA
     JOIN #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS  B             ON B.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
     JOIN PDV_FINALIZADORAS_STATUS                  Y WITH(NOLOCK)ON Y.LOJA                         = B.LOJA_ORIGINAL
                                                                 AND Y.MOVIMENTO                    = B.MOVIMENTO_VENDA
                                                                 AND Y.VENDA                        = B.VENDA_ORIGINAL
                                                                 AND Y.CAIXA                        = B.CAIXA_ORIGINAL
                                                                 AND Y.STATUS                       = 'A'
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS C WITH(NOLOCK)ON C.LOJA                         = B.LOJA
                                                                 AND C.MOVIMENTO                    = B.MOVIMENTO
                                                                 AND C.CAIXA                        = B.CAIXA
                                                                 AND C.VENDA                        = B.VENDA
     LEFT
     JOIN ENTIDADES_CONVENIOS_CARTOES               D WITH(NOLOCK)ON D.CONVENIO_CARTAO              = B.CLIENTE
     LEFT
     JOIN ENTIDADES                                 E WITH(NOLOCK)ON E.ENTIDADE                     = B.CODIGO_CONVENIO
     LEFT
     JOIN CONVENIOS_CONFERENCIAS_CUPONS             F WITH(NOLOCK)ON F.LOJA                         = Y.LOJA
                                                                 AND F.MOVIMENTO                    = Y.MOVIMENTO
                                                                 AND F.VENDA                        = Y.VENDA
                                                                 AND F.CAIXA                        = Y.CAIXA

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 5
      AND ISNULL(B.CODIGO_PBM,0)          = 0

    ORDER BY
          MOVIMENTO ,
          CAIXA      


PRINT '----------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A CARTÕES PRÓPRIOS --'
PRINT '----------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          MOVIMENTO                    ,
          VENDA                        ,
          ECF_CUPOM                    ,
          CONVENIO_CARTAO              ,
          NOME                         ,
          CODIGO_CONVENIO              ,
          PARCELAS                     ,
          VALOR                        ,
          TITULO_RECEBER               ,
          CONFERIDO                    
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,
          B.CLIENTE                      AS CONVENIO_CARTAO              ,
          D.NOME                         AS NOME                         ,
          E.ENTIDADE                     AS CODIGO_CONVENIO              ,
          B.PARCELAS                     AS PARCELAS                     ,
          B.VALOR                        AS VALOR                        ,
          MIN(G.TITULO_RECEBER)          AS TITULO_RECEBER               ,
          --CASE WHEN X.STATUS = 'A' 
          --     THEN CASE WHEN B.STATUS = 'A' 
          --               THEN ( B.VALOR - B.TROCO )
          --               ELSE ( B.VALOR - B.TROCO ) * (-1) 
          --          END 
          --     ELSE 0 
          --END                            AS VALOR                        ,
          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS              A WITH(NOLOCK)
     JOIN #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS     B             ON B.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
     JOIN PDV_FINALIZADORAS_STATUS                     Y WITH(NOLOCK)ON Y.LOJA                         = B.LOJA_ORIGINAL
                                                                    AND Y.MOVIMENTO                    = B.MOVIMENTO_VENDA
                                                                    AND Y.VENDA                        = B.VENDA_ORIGINAL
                                                                    AND Y.CAIXA                        = B.CAIXA_ORIGINAL
                                                                    AND Y.FINALIZADORA                 = B.FINALIZADORA
                                                                    AND Y.STATUS                       = 'A'
     --JOIN PDV_VENDAS                                 X WITH(NOLOCK)ON X.EMPRESA                      = A.EMPRESA
     --                                                             AND X.MOVIMENTO                    = @MOVIMENTO
     --JOIN PDV_FINALIZADORAS                          B WITH(NOLOCK)ON B.LOJA                         = X.LOJA
     --                                                             AND B.MOVIMENTO                    = X.MOVIMENTO
     --                                                             AND B.VENDA                        = X.VENDA
     --                                                             AND B.CAIXA                        = X.CAIXA
     LEFT                                                                                               
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS    C WITH(NOLOCK)ON C.LOJA                         = B.LOJA
                                                                    AND C.MOVIMENTO                    = B.MOVIMENTO
                                                                    AND C.CAIXA                        = B.CAIXA
                                                                    AND C.VENDA                        = B.VENDA
     JOIN ENTIDADES_CONVENIOS_CARTOES                  D WITH(NOLOCK)ON D.CONVENIO_CARTAO              = B.CLIENTE
     JOIN ENTIDADES                                    E WITH(NOLOCK)ON E.ENTIDADE                     = B.CODIGO_CONVENIO
     LEFT --ADD POR AGATHA NIGRO 14/10/2016 (FAMILIAR DEMANDA 171864)
     JOIN PDV_CONVENIOS                                F WITH(NOLOCK)ON F.LOJA                         = Y.LOJA
                                                                    AND F.MOVIMENTO                    = Y.MOVIMENTO
                                                                    AND F.VENDA                        = Y.VENDA
                                                                    AND F.CAIXA                        = Y.CAIXA
     LEFT                                                                                               
     JOIN TITULOS_RECEBER                              G WITH(NOLOCK)ON G.REG_MASTER_ORIGEM            = F.FECHAMENTO_CARTAO_PROPRIO              -- Alinhado com Andrei, o cliente irá passar a realizar a conferencia.
                                                                    AND G.FORMULARIO_ORIGEM            = 751166  --FECHAMENTOS_CONVENIOS_CARTOES  -- KAROL (22/12/2016)
                                                                    AND G.TAB_MASTER_ORIGEM            = 750078  
                                                                    AND G.REGISTRO_CONTROLE            = F.PDV_CONVENIO


    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      --AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 6

    GROUP BY
          A.FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA ,
          A.REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         ,
          B.CAIXA                        ,
          B.MOVIMENTO                    ,
          B.VENDA                        ,
          B.ECF_CUPOM                    ,
          B.CLIENTE                      ,
          D.NOME                         ,
          E.ENTIDADE                     ,
          B.PARCELAS                     ,
          B.VALOR                        

    ORDER BY
          MOVIMENTO ,
          CAIXA      

PRINT '---------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A PBM --'
PRINT '---------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          MOVIMENTO                    ,
          VENDA                        ,
          ECF_CUPOM                    ,
          PBM                          ,
          PARCELAS                     ,
          VALOR                        ,
          CONFERIDO                    ,
          NSU                          
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,
          B.CODIGO_PBM                   AS PBM                          ,
          B.PARCELAS                     AS PARCELAS                     ,

          SUM(CASE WHEN X.STATUS = 'A' 
                   THEN CASE WHEN B.STATUS = 'A' 
                             THEN ( B.VALOR - B.TROCO )
                             ELSE ( B.VALOR - B.TROCO ) * (-1) 
                        END 
                   ELSE 0 
              END)                       AS VALOR                        ,

          --'S'                            AS CONFERIDO                    , --AGATHA 09/06/2016 -- PEDIDO DO CONSULTOR GABRIEL    /* COMENTADO POR KAROL EM 11/07/2016 */
          'N'                            AS CONFERIDO                    ,   --KAROL  11/07/2016 -- PEDIDO DO CONSULTOR ANDREI
          --B.NSU                          AS NSU
          COALESCE(X.FCARD_AUTORIZACAO,Z.NSU_PBM,B.NSU)      AS NSU                          
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS           A WITH(NOLOCK)
     JOIN #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS  W WITH(NOLOCK)ON W.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
     JOIN PDV_VENDAS                                X WITH(NOLOCK)ON W.LOJA                         = X.LOJA
                                                                 AND W.MOVIMENTO_VENDA              = X.MOVIMENTO
                                                                 AND W.CAIXA_ORIGINAL               = X.CAIXA
                                                                 AND W.VENDA                        = X.VENDA
                                                                 AND W.TIPO                         = 5
     JOIN PDV_FINALIZADORAS                         B WITH(NOLOCK)ON B.LOJA                         = X.LOJA
                                                                 AND B.MOVIMENTO                    = X.MOVIMENTO
                                                                 AND B.VENDA                        = X.VENDA
                                                                 AND B.CAIXA                        = X.CAIXA
     JOIN PDV_FINALIZADORAS_STATUS                  Y WITH(NOLOCK)ON Y.LOJA                         = B.LOJA
                                                                 AND Y.MOVIMENTO                    = B.MOVIMENTO
                                                                 AND Y.VENDA                        = B.VENDA
                                                                 AND Y.CAIXA                        = B.CAIXA
                                                                 AND Y.REGISTRO                     = B.REGISTRO
                                                                 AND Y.STATUS                       = 'A'
     LEFT                                            
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM       C WITH(NOLOCK)ON C.LOJA                         = B.LOJA
                                                                 AND C.MOVIMENTO                    = B.MOVIMENTO
                                                                 AND C.CAIXA                        = B.CAIXA
                                                                 AND C.VENDA                        = B.VENDA
    LEFT                                                                                            
    JOIN PDV_PREAUTORIZACOES_CABECALHO              Z WITH(NOLOCK)ON Z.LOJA                         = X.LOJA
                                                                 AND Z.PREVENDA                     = X.PREVENDA

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 5
      AND ISNULL(B.CODIGO_PBM,0)          > 0

    GROUP BY A.FORMULARIO_ORIGEM           
           , A.TAB_MASTER_ORIGEM           
           , A.CONFERENCIA_FECHAMENTO_CAIXA
           , A.REG_LOG_INCLUSAO            
           , A.CONFERENCIA_FECHAMENTO_CAIXA
           , B.LOJA                        
           , B.CAIXA                       
           , B.MOVIMENTO                   
           , B.VENDA                       
           , B.ECF_CUPOM                   
           , B.CODIGO_PBM                  
           , B.PARCELAS   
           , COALESCE(X.FCARD_AUTORIZACAO,Z.NSU_PBM,B.NSU)
           
    HAVING SUM(CASE WHEN X.STATUS = 'A' 
                    THEN CASE WHEN B.STATUS = 'A' 
                              THEN ( B.VALOR - B.TROCO )
                              ELSE ( B.VALOR - B.TROCO ) * (-1) 
                         END 
                    ELSE 0 
               END) > 0
 
    ORDER BY
          MOVIMENTO ,
          CAIXA     


PRINT '-------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A FATURADOS     --'
PRINT '-------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          MOVIMENTO                    ,
          VENDA                        ,
          ECF_CUPOM                    ,
          VALOR                        ,
          NF_FATURAMENTO               ,
          TITULO_RECEBER               ,
          ENTIDADE                     ,
          VALOR_TITULO                 ,
          CONFERIDO                    
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,

          SUM(CASE WHEN X.STATUS = 'A' 
                   THEN CASE WHEN B.STATUS = 'A' 
                             THEN ( B.VALOR - B.TROCO )
                             ELSE ( B.VALOR - B.TROCO ) * (-1) 
                        END 
                   ELSE 0 
              END)                       AS VALOR                        ,

          E.NF_FATURAMENTO               AS NF_FATURAMENTO               ,
          F.TITULO_RECEBER               AS TITULO_RECEBER               ,
          G.ENTIDADE                     AS ENTIDADE                     ,
          F.VALOR                        AS VALOR_TITULO                 ,
          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS           A WITH(NOLOCK)
     JOIN #RESULTADO_PDV_VENDAS_FECHAMENTOS_CAIXAS  Y             ON Y.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
     JOIN PDV_VENDAS                                X WITH(NOLOCK)ON Y.LOJA                         = X.LOJA
                                                                 AND Y.MOVIMENTO_VENDA              = X.MOVIMENTO
                                                                 AND Y.CAIXA                        = X.CAIXA
                                                                 AND Y.VENDA                        = X.VENDA
                                                                 AND Y.TIPO                         = 7
     JOIN PDV_FINALIZADORAS                         B WITH(NOLOCK)ON B.LOJA                         = X.LOJA
                                                                 AND B.MOVIMENTO                    = X.MOVIMENTO
                                                                 AND B.VENDA                        = X.VENDA
                                                                 AND B.CAIXA                        = X.CAIXA
     LEFT                                                                                            
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS C WITH(NOLOCK)ON C.LOJA                         = B.LOJA
                                                                 AND C.MOVIMENTO                    = B.MOVIMENTO
                                                                 AND C.CAIXA                        = B.CAIXA
                                                                 AND C.VENDA                        = B.VENDA
     LEFT                                                                                            
     JOIN NF_FATURAMENTO_CUPOM                      D WITH(NOLOCK)ON D.CAIXA                        = B.FINALIZADORA
                                                                 AND D.FILIAL                       = B.LOJA
                                                                 AND D.MOVIMENTO                    = B.MOVIMENTO
                                                                 AND D.CUPOM                        = CONVERT(NUMERIC(10),B.ECF_CUPOM)
     LEFT                                                                                            
     JOIN NF_FATURAMENTO                            E WITH(NOLOCK)ON E.NF_FATURAMENTO               = D.NF_FATURAMENTO
     LEFT                                                                                            
     JOIN TITULOS_RECEBER                           F WITH(NOLOCK)ON F.FORMULARIO_ORIGEM            = E.FORMULARIO_ORIGEM
                                                                 AND F.TAB_MASTER_ORIGEM            = E.TAB_MASTER_ORIGEM
                                                                 AND F.REG_MASTER_ORIGEM            = E.NF_FATURAMENTO
    LEFT                                                                                            
    JOIN ENTIDADES                                  G WITH(NOLOCK)ON G.ENTIDADE                     = B.CLIENTE
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL
      AND B.TIPO                          = 7

    GROUP BY
          A.FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA ,
          A.REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         ,
          B.CAIXA                        ,
          B.MOVIMENTO                    ,
          B.VENDA                        ,
          B.ECF_CUPOM                    ,
          E.NF_FATURAMENTO               ,
          F.TITULO_RECEBER               ,                                       
          G.ENTIDADE                     ,
          F.VALOR                        

   HAVING SUM(CASE WHEN X.STATUS = 'A' 
                   THEN CASE WHEN B.STATUS = 'A' 
                             THEN ( B.VALOR - B.TROCO )
                             ELSE ( B.VALOR - B.TROCO ) * (-1) 
                        END 
                   ELSE 0 
               END) > 0

    ORDER BY
          MOVIMENTO ,
          CAIXA     

PRINT '-------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE AO VALE CRÉDITO --'
PRINT '-------------------------------------------------------------'

 IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS_001' ) IS NOT NULL 
 DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS_001

   SELECT 
          @CONFERENCIA_FECHAMENTO_CAIXA  AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                         AS LOJA                         ,
          B.CAIXA                        AS CAIXA                        ,        
          CASE 
             WHEN X.ORIGEM_PREVENDA = 'T'
             THEN B1.MOVIMENTO           
             ELSE B.MOVIMENTO             
             END                         AS MOVIMENTO                    ,
          B.VENDA                        AS VENDA                        ,
          B.ECF_CUPOM                    AS ECF_CUPOM                    ,
          SUM(CASE WHEN X.STATUS = 'A' 
                   THEN CASE WHEN B.STATUS = 'A' 
                             THEN ( B.VALOR - B.TROCO )
                             ELSE ( B.VALOR - B.TROCO ) * (-1) 
                        END 
                   ELSE 0 
              END)                       AS VALOR                        ,
          B.VALE_CREDITO                 AS CREDITO_CLIENTE              ,    
          'N'                            AS CONFERIDO  
          
         INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS_001

     FROM PDV_VENDAS                                X WITH(NOLOCK)
                                                                 
     JOIN PDV_FINALIZADORAS                         B WITH(NOLOCK)ON B.LOJA       = X.LOJA
                                                                 AND B.MOVIMENTO  = X.MOVIMENTO
                                                                 AND B.VENDA      = X.VENDA
                                                                 AND B.CAIXA      = X.CAIXA

     LEFT 
     JOIN PDV_ROMANEIOS_RECEBIMENTOS_FINALIZADORAS B1 WITH(NOLOCK)ON B1.LOJA             = X.LOJA
                                                              -- AND B1.CAIXA            = X.CAIXA  --20/05/2022 -- BRUNO SANTANA 
                                                                 AND B1.PREVENDA         = X.PREVENDA 
                                                                 AND B1.MOVIMENTO_VENDA  = X.MOVIMENTO 
                                                                 AND B1.VENDA            = X.VENDA 
                                                                 AND B1.TIPO             = 8 
                                                                 AND B1.VALOR            = B.VALOR
      
                                                             
     LEFT
     JOIN CREDITOS_CLIENTES                         D WITH(NOLOCK) ON D.CREDITO_CLIENTE = B.VALE_CREDITO

    WHERE 1=1    
      AND B.TIPO                          = 8
      AND X.EMPRESA                       = @EMPRESA
      AND CASE 
             WHEN X.ORIGEM_PREVENDA = 'T' 
             THEN ISNULL (B1.MOVIMENTO, X.MOVIMENTO)
             ELSE X.MOVIMENTO 
             END = @MOVIMENTO 

    GROUP BY
    
          B.LOJA                         ,
          B.CAIXA                        ,
          CASE 
             WHEN X.ORIGEM_PREVENDA = 'T'
             THEN B1.MOVIMENTO           
             ELSE B.MOVIMENTO   
          END                            ,     
          B.VENDA                        ,
          B.ECF_CUPOM                    ,
          B.VALE_CREDITO                 ,
           B.VALOR

   HAVING SUM(CASE WHEN X.STATUS = 'A' 
                   THEN CASE WHEN B.STATUS = 'A' 
                             THEN ( B.VALOR - B.TROCO )
                       ELSE ( B.VALOR - B.TROCO ) * (-1) 
                        END 
                   ELSE 0 
               END) > 0

    ORDER BY
          MOVIMENTO ,
          CAIXA 


   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          MOVIMENTO                    ,
          VENDA                        ,
          ECF_CUPOM                    ,
          VALOR                        ,
          CREDITO_CLIENTE              , -- Chave Vale Crédito
          CONFERIDO                    
         )

   SELECT
        A.FORMULARIO_ORIGEM            ,
        A.TAB_MASTER_ORIGEM            ,
        A.REG_MASTER_ORIGEM            ,
        A.REG_LOG_INCLUSAO             ,
        A.CONFERENCIA_FECHAMENTO_CAIXA ,
        G.LOJA                         ,
        G.CAIXA                        ,
        G.MOVIMENTO                    ,
        G.VENDA                        ,
        G.ECF_CUPOM                    ,
        G.VALOR                        ,
        G.CREDITO_CLIENTE              ,
        G.CONFERIDO  


        
     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS            A WITH(NOLOCK)
     JOIN #CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS_001 G WITH(NOLOCK) ON G.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA
                                                                       AND G.LOJA                         = A.EMPRESA 
                                                                       AND G.MOVIMENTO                    = @MOVIMENTO 
     
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS C WITH(NOLOCK)ON C.LOJA       = G.LOJA
                                                                 AND C.MOVIMENTO  = G.MOVIMENTO
                                                                 AND C.CAIXA      = G.CAIXA
                                                                 AND C.VENDA      = G.VENDA

    


    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL





PRINT '---------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE AO VALE DE FUNCIONÁRIOS --'
PRINT '---------------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          VALE_FUNCIONARIO             ,
          DATA_HORA                    ,
          USUARIO_LOGADO               ,
          MOVIMENTO                    ,
          TIPO_VALE                    ,
          CAIXA_LOJA                   ,
          FUNCIONARIO                  ,
          VENDEDOR                     ,
          VALOR                        ,
          OBSERVACAO                   ,
          ABERTURA_CAIXA               ,
          CONFERIDO                    
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.VALE_FUNCIONARIO             AS VALE_FUNCIONARIO             ,
          B.DATA_HORA                    AS DATA_HORA                    ,
          B.USUARIO_LOGADO               AS USUARIO_LOGADO               ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.TIPO_VALE                    AS TIPO_VALE                    ,
          B.CAIXA_LOJA                   AS CAIXA_LOJA                   ,
          B.FUNCIONARIO                  AS FUNCIONARIO                  ,
          B.VENDEDOR                     AS VENDEDOR                     ,
          B.VALOR                        AS VALOR                        ,
          B.OBSERVACAO                   AS OBSERVACAO                   ,
          B.ABERTURA_CAIXA               AS ABERTURA_CAIXA               ,
          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS            A WITH(NOLOCK)
     JOIN VALES_FUNCIONARIOS_LOJAS                   B WITH(NOLOCK)ON B.EMPRESA          = A.EMPRESA
                                                                  AND B.MOVIMENTO        = A.MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC C WITH(NOLOCK)ON C.VALE_FUNCIONARIO = B.VALE_FUNCIONARIO

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL

    ORDER BY
          MOVIMENTO 


PRINT '---------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE ÀS DESPESAS DE COFRE    --'
PRINT '---------------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          DESPESA_COFRE                ,
          DATA_HORA                    ,
          USUARIO_LOGADO               ,
          EMPRESA                      ,
          MOVIMENTO                    ,
          ENTIDADE                     ,
          CLASSIF_FINANCEIRA           ,
          DESPESA                      ,
          OBSERVACAO                   ,
          CONFERIDO                    
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.DESPESA_COFRE                AS DESPESA_COFRE                ,
          B.DATA_HORA                    AS DATA_HORA                    ,
          B.USUARIO_LOGADO               AS USUARIO_LOGADO               ,
          B.EMPRESA                      AS EMPRESA                      ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.ENTIDADE                     AS ENTIDADE                     ,
          B.CLASSIF_FINANCEIRA           AS CLASSIF_FINANCEIRA           ,
          B.DESPESA                      AS DESPESA                      ,
          B.OBSERVACAO                   AS OBSERVACAO                   ,
          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS          A WITH(NOLOCK)
     JOIN DESPESAS_COFRES                          B WITH(NOLOCK)ON B.EMPRESA       = A.EMPRESA
                                                                AND B.MOVIMENTO     = A.MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS C WITH(NOLOCK)ON C.DESPESA_COFRE = B.DESPESA_COFRE

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL

    ORDER BY
          MOVIMENTO 


PRINT '----------------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE DEVOLUÇÃO DE DINHEIRO DO COFRE --'
PRINT '----------------------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,                                                                           
          DEVOLUCAO_DINHEIRO           ,
          DATA_HORA                    ,
          USUARIO_LOGADO               ,
          EMPRESA                      ,
          MOVIMENTO                    ,
          DEVOLUCAO_PRODUTO            ,
          TOTAL_DEVOLUCAO              ,
          CONFERIDO                    
         )

   SELECT A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.DEVOLUCAO_DINHEIRO           AS DEVOLUCAO_DINHEIRO           ,
          B.DATA_HORA                    AS DATA_HORA                    ,
          B.USUARIO_LOGADO               AS USUARIO_LOGADO               ,
          B.EMPRESA                      AS EMPRESA                      ,
          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.DEVOLUCAO_PRODUTO            AS DEVOLUCAO_PRODUTO            ,
          D.VALOR_DEVOLVIDO              AS TOTAL_DEVOLUCAO              ,
          'N'                            AS CONFERIDO                    

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS              A WITH(NOLOCK)
     JOIN DEV_DINHEIRO_CAIXAS                          B WITH(NOLOCK)ON B.EMPRESA            = A.EMPRESA
     JOIN DEV_DINHEIRO_TOTAIS                          D WITH(NOLOCK)ON D.DEVOLUCAO_DINHEIRO = B.DEVOLUCAO_DINHEIRO 
                                                                    AND B.MOVIMENTO          = A.MOVIMENTO
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO C WITH(NOLOCK)ON C.DEVOLUCAO_DINHEIRO = B.DEVOLUCAO_DINHEIRO

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL

    ORDER BY
          MOVIMENTO 

PRINT '-----------------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE DEVOLUÇÃO EMITIDAS NO MOVIMENTO --'
PRINT '-----------------------------------------------------------------------------'

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES
         (
          FORMULARIO_ORIGEM            ,
          TAB_MASTER_ORIGEM            ,
          REG_MASTER_ORIGEM            ,
          REG_LOG_INCLUSAO             ,
          CONFERENCIA_FECHAMENTO_CAIXA ,
          LOJA                         ,
          CAIXA                        ,
          DATA_COMPRA                  ,
          VENDA                        ,
          ECF_CUPOM                    ,
          VALOR                        ,
          MOVIMENTO                    ,
          DEVOLUCAO_PRODUTO            ,
          ENTIDADE                     ,
          TOTAL_DEVOLUCAO              ,
          CONFERIDO
         )

    SELECT 
          A.FORMULARIO_ORIGEM            AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO             AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.EMPRESA                      AS LOJA                         ,
          B.CAIXA_LOJA                   AS CAIXA                        ,
          B.DATA_COMPRA                  AS DATA_COMPRA                  ,
          E.VENDA                        AS VENDA                        ,
          B.CUPOM                        AS ECF_CUPOM                    ,

          SUM(E.VALOR)                   AS VALOR                        ,

          B.MOVIMENTO                    AS MOVIMENTO                    ,
          B.DEVOLUCAO_PRODUTO            AS DEVOLUCAO_PRODUTO            ,
          B.ENTIDADE                     AS ENTIDADE                     ,
          D.VALOR_TOTAL_DEVOLUCAO        AS TOTAL_DEVOLUCAO              ,
          --'S'                            AS CONFERIDO                     -- MATHIAS - 2015 09 03 - CONDE NÃO FAZ ESTA CONFERÊNCIA - ALINHADO COM ALBERTO  ----CONFIRMADO COM O CONSULTOR GABRIEL PARA FICAR ASSIM NA PERMANENTE 
                                                                            /* COMENTADO POR KAROL EM 11/07/2016 */
          
          'N'                            AS CONFERIDO                       --KAROL  11/07/2016 -- PEDIDO DO CONSULTOR ANDREI

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS            A WITH(NOLOCK)
     JOIN DEV_PRODUTOS_CAIXAS                        B WITH(NOLOCK)ON B.EMPRESA                = A.EMPRESA
                                                                  AND CONVERT(DATE,B.MOVIMENTO)= A.MOVIMENTO
     JOIN DEV_PRODUTOS_TOTAIS                        D WITH(NOLOCK)ON D.DEVOLUCAO_PRODUTO      = B.DEVOLUCAO_PRODUTO
     --CROSS APPLY PDV_VENDAS_FECHAMENTOS_CAIXAS ( B.DATA_COMPRA ,
     --                                            B.DATA_COMPRA ,
     --                                            @EMPRESA      ,
     --                                            @EMPRESA      )  E    
     JOIN PDV_VENDAS                                 X WITH(NOLOCK)ON X.LOJA                   = B.EMPRESA
                                                                  AND X.MOVIMENTO              = CONVERT(DATE,B.DATA_COMPRA)
                                                                  AND X.ECF_CUPOM              = B.CUPOM 
                                                                  AND DBO.ZEROS(X.ECF_CAIXA,4) = DBO.ZEROS(B.ECF_CAIXA,4)
     JOIN PDV_FINALIZADORAS                          E WITH(NOLOCK)ON E.LOJA              = X.LOJA
                                                                  AND E.MOVIMENTO         = X.MOVIMENTO
                                                                  AND E.VENDA             = X.VENDA
                                                                  AND E.CAIXA             = X.CAIXA
     LEFT
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_DEVOLUCOES C WITH(NOLOCK)ON C.DEVOLUCAO_PRODUTO = B.DEVOLUCAO_PRODUTO

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA  = @CONFERENCIA_FECHAMENTO_CAIXA
      --AND DBO.ZEROS(E.ECF_CUPOM,6)   = DBO.ZEROS(B.CUPOM    ,6)
      --AND DBO.ZEROS(E.ECF_CAIXA,4)   = DBO.ZEROS(B.ECF_CAIXA,4)
      AND C.CONFERENCIA_FECHAMENTO_CAIXA IS NULL

    GROUP BY 
          A.FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA ,
          A.REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA ,
          B.EMPRESA                      ,
          B.CAIXA_LOJA                   ,
          B.DATA_COMPRA                  ,
          E.VENDA                        ,
          B.CUPOM                        ,
          B.MOVIMENTO                    ,
          B.DEVOLUCAO_PRODUTO            ,
          B.ENTIDADE                     ,
          D.VALOR_TOTAL_DEVOLUCAO        

    ORDER BY
          MOVIMENTO 
 
PRINT '-----------------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS MOVIMENTAÇÕES REFERENTE A CUPONS CANCELADOS NO MOVIMENTO --'
PRINT '-----------------------------------------------------------------------------'

   INSERT
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS (
          FORMULARIO_ORIGEM           ,
          TAB_MASTER_ORIGEM           ,
          REG_MASTER_ORIGEM           ,
          REG_LOG_INCLUSAO            ,
          CONFERENCIA_FECHAMENTO_CAIXA,
          LOJA                        ,   
          MOVIMENTO                   ,  
          CAIXA                       ,  
          VENDA                       ,  
          ECF_CUPOM                   ,     
          VENDEDOR                    ,  
          TIPO                        ,
          TOTAL                       ,
          CONFERIDO                   ,
          DATA_CANCELAMENTO           ,
          OBSERVACAO                  ,
          TIPO_FINALIZADORA           ,
          OBSERVACAO_PDV              )

   SELECT A.FORMULARIO_ORIGEM                     AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM                     AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA          AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO                      AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA          AS CONFERENCIA_FECHAMENTO_CAIXA ,
          B.LOJA                                  AS LOJA , 
          B.MOVIMENTO                             AS MOVIMENTO,
          B.CAIXA                                 AS CAIXA ,
          B.VENDA                                 AS VENDA,
          B.ECF_CUPOM                             AS ECF_CUPOM ,
          G.VENDEDOR                              AS VENDEDOR ,
          'T'                                     AS TIPO              ,
          X.ITENS_TOTAL_PRECO_LIQUIDO_ORIGINAL    AS TOTAL             , -- TOTAL - ANTES TRATAVAMOS SE HAVIAM ITENS CANCELADOS ENTÃO TINHA TIPO = 'P' de "parcial"
          --B.VENDEDOR                              AS VENDEDOR , 
          --CASE WHEN SUM(CASE WHEN B.STATUS = 'A' THEN 1 ELSE 0 END ) > 0
          --     THEN 'P'
          --     ELSE 'T'
          --END                                   AS TIPO ,         
            --CAST (SUM(CASE WHEN B.STATUS = 'C'
            --         THEN CASE WHEN C.STATUS = 'C'
            --                   THEN 1
            --                   ELSE 0
            --              END 
            --         ELSE CASE WHEN B.[STATUS] = 'A'
            --                   THEN CASE WHEN C.STATUS = 'C'
            --                             THEN 1
            --                             ELSE 0
            --                        END
            --              END
            --    END * (C.QUANTIDADE * (C.PRECO-C.DESCONTO) ))   AS NUMERIC (15,2))  AS TOTAL , 
          'S'                                     AS CONFERIDO,
          B.DATA_HORA_GRAVACAO                    AS DATA_CANCELAMENTO,
          CASE WHEN H.TIPO IS NULL
                THEN 'Venda não finalizada.'  
                ELSE ''
          END                                     AS OBSERVACAO        ,
          H.TIPO                                  AS TIPO_FINALIZADORA ,
          B.CANCELAMENTO_OBS                      AS OBSERVACAO_PDV

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS                   A WITH(NOLOCK)   
     JOIN PDV_VENDAS                                        B WITH(NOLOCK) ON B.MOVIMENTO       = A.MOVIMENTO  
                                                                          AND B.LOJA            = A.EMPRESA            
     --JOIN PDV_ITENS                                         C WITH(NOLOCK) ON C.MOVIMENTO      = B.MOVIMENTO 
     --                                                                     AND C.VENDA          = B.VENDA
     --                                                                     AND C.LOJA           = B.LOJA 
     --                                                                     AND C.CAIXA          = B.CAIXA
     JOIN PDV_VENDAS_STATUS                                 X WITH(NOLOCK) ON X.MOVIMENTO       = B.MOVIMENTO 
                                                                          AND X.VENDA           = B.VENDA
                                                                          AND X.LOJA            = B.LOJA 
                                                                          AND X.CAIXA           = B.CAIXA
     JOIN EMPRESAS_USUARIAS                                 D WITH(NOLOCK) ON D.EMPRESA_USUARIA = B.LOJA
     JOIN EMPRESAS_USUARIAS                                 E WITH(NOLOCK) ON E.EMPRESA_USUARIA = D.EMPRESA_CONTABIL      
     LEFT                                                    
     JOIN VENDEDORES                                        G WITH(NOLOCK) ON G.VENDEDOR        = B.VENDEDOR
     LEFT 
     JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_CUPONS_CANCELADOS F WITH(NOLOCK) ON F.MOVIMENTO       = B.MOVIMENTO
                                                                          AND F.LOJA            = B.LOJA
                                                                          AND F.VENDA           = B.VENDA
                                                                          AND F.CAIXA           = B.ECF_CAIXA
                                                                          --AND F.ECF_CUPOM = B.ECF_CUPOM
     LEFT
     JOIN PDV_FINALIZADORAS                                 H WITH(NOLOCK) ON H.MOVIMENTO       = B.MOVIMENTO                          
                                                                          AND H.VENDA           = B.VENDA
                                                                          AND H.LOJA            = B.LOJA 
                                                                          AND H.ECF_CUPOM       = B.ECF_CUPOM
                                                                          AND H.CAIXA           = B.CAIXA
    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA =@CONFERENCIA_FECHAMENTO_CAIXA
      AND X.STATUS                       = 'C' 
      AND F.CONFERENCIA_FECHAMENTO_CAIXA_CUPOM_CANCELADO IS NULL 
    GROUP BY                                                                                                                      
          A.FORMULARIO_ORIGEM                     ,
          A.TAB_MASTER_ORIGEM                     ,
          A.CONFERENCIA_FECHAMENTO_CAIXA          ,
          A.REG_LOG_INCLUSAO                      ,
          A.CONFERENCIA_FECHAMENTO_CAIXA          ,  
          B.LOJA                                  ,
          B.MOVIMENTO                             ,
          B.CAIXA                                 ,
          B.VENDA                                   ,           
          B.ECF_CUPOM                             ,
          G.VENDEDOR                              ,
          X.ITENS_TOTAL_PRECO_LIQUIDO_ORIGINAL    ,
          B.DATA_HORA_GRAVACAO                    ,                                     
          CASE WHEN H.TIPO IS NULL
               THEN 'Venda não finalizada.'  
               ELSE ''                                                     
          END                                     ,
          H.TIPO                                  ,
          B.CANCELAMENTO_OBS                       
                                                                        
    ORDER BY B.LOJA , B.CAIXA , B.ECF_CUPOM


PRINT '-------------------------------------------------------------------------------------------'
PRINT '-- INSERE AS OBSERVACOES DOS FECHAMENTOS DE CAIXAS DE ACORDO COM A EMPRESA E O MOVIMENTO --'
PRINT '-------------------------------------------------------------------------------------------'


 IF OBJECT_ID('TEMPDB..#CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES_001' ) IS NOT NULL 
 DROP TABLE #CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES_001     

 SELECT A.FECHAMENTO_CAIXA                          AS FECHAMENTO_CAIXA
       ,A.OPERADOR                                  AS OPERADOR 
       ,UPPER (CONVERT(VARCHAR (255),B.OCORRENCIA)) AS OCORRENCIA      

   INTO #CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES_001
   FROM FECHAMENTOS_CAIXAS                          A WITH(NOLOCK)
   LEFT                                       
   JOIN OCORRENCIAS_FECHAMENTOS_CAIXAS              B WITH(NOLOCK) ON B.FECHAMENTO_CAIXA = A.FECHAMENTO_CAIXA 
   LEFT
   JOIN CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES C WITH(NOLOCK) ON C.FECHAMENTO_CAIXA = A.FECHAMENTO_CAIXA 

  WHERE A.EMPRESA   = @EMPRESA
    AND A.MOVIMENTO = @MOVIMENTO 
    AND C.FECHAMENTO_CAIXA IS NULL 


 INSERT 
   INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES
        (
         FECHAMENTO_CAIXA
        ,OPERADOR
        ,OCORRENCIA
        ,CONFERENCIA_FECHAMENTO_CAIXA
        )
   SELECT 
         A.FECHAMENTO_CAIXA             AS FECHAMENTO_CAIXA
        ,A.OPERADOR                     AS OPERADOR
        ,A.OCORRENCIA                   AS OCORRENCIA
        ,@CONFERENCIA_FECHAMENTO_CAIXA  AS CONFERENCIA_FECHAMENTO_CAIXA
     FROM 
        #CONFERENCIAS_FECHAMENTOS_CAIXAS_OBSERVACOES_001 A WITH(NOLOCK)


PRINT '----------------------------------------------------------------------------'
PRINT '-- ROTINA PARA ATUALIZAR O CAMPO CONFERIDO QUANDO A VENDA ESTA CONCILIADA --'
PRINT '----------------------------------------------------------------------------'

--0006
--ANDERSON SILVA 08/08/2022--              
EXEC USP_FUNCAO_CONFERENCIAS_CAIXAS_ATUALIZAR_CONFERIDO @CONFERENCIA_FECHAMENTO_CAIXA      
        
        
PRINT '---------------------------------------------------------------------------'
PRINT '-- INSERE OS DADOS REFERENTE A TOTALIZAÇÃO DAS DETAILS DAS FINALIZADORAS --'
PRINT '---------------------------------------------------------------------------'


DELETE CONFERENCIAS_FECHAMENTOS_CAIXAS_TOTAIS
  FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_TOTAIS A WITH(NOLOCK)
 WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA
            

   INSERT 
     INTO CONFERENCIAS_FECHAMENTOS_CAIXAS_TOTAIS
         (
           FORMULARIO_ORIGEM            ,
           TAB_MASTER_ORIGEM            ,
           REG_MASTER_ORIGEM            ,
           REG_LOG_INCLUSAO             ,
           CONFERENCIA_FECHAMENTO_CAIXA ,
           ENVIO_DINHEIRO               ,
           ENVIO_CHEQUE                 ,
           ENVIO_CHEQUE_PREDATADO       ,
           DEPOSITO_DINHEIRO            ,
           DEPOSITO_CHEQUE              ,
           VALOR_TEF                    ,
           VALOR_POS                    ,
           CONVENIO                     ,
           PBM                          ,
           CARTAO_PROPRIO               ,
           FATURADOS                    ,
           VALE_CREDITO                 ,
           VALE_FUNCIONARIO             ,
           DESPESAS                     ,
           DEVOLUCAO                    ,
           VALOR_AJUSTE_POS                   
         )


   SELECT A.FORMULARIO_ORIGEM                AS FORMULARIO_ORIGEM            ,
          A.TAB_MASTER_ORIGEM                AS TAB_MASTER_ORIGEM            ,
          A.CONFERENCIA_FECHAMENTO_CAIXA     AS REG_MASTER_ORIGEM            ,
          A.REG_LOG_INCLUSAO                 AS REG_LOG_INCLUSAO             ,
          A.CONFERENCIA_FECHAMENTO_CAIXA     AS CONFERENCIA_FECHAMENTO_CAIXA ,
          ISNULL(B.ENVIO_DINHEIRO        ,0) AS ENVIO_DINHEIRO               ,--
          ISNULL(B.ENVIO_CHEQUE          ,0) AS ENVIO_CHEQUE                 ,--
          ISNULL(B.ENVIO_CHEQUE_PREDATADO,0) AS ENVIO_CHEQUE_PREDATADO       ,--
          ISNULL(C.VALOR                 ,0) AS DEPOSITO_DINHEIRO            ,--
          ISNULL(D.VALOR                 ,0) AS DEPOSITO_CHEQUE              ,--
          ISNULL(E.VALOR                 ,0) AS VALOR_TEF                    ,--
          ISNULL(F.VALOR                 ,0) AS VALOR_POS                    ,--
          ISNULL(G.VALOR                 ,0) AS CONVENIO                     ,--
          ISNULL(H.VALOR                 ,0) AS PBM                          ,--                                    
          ISNULL(I.VALOR                 ,0) AS CARTAO_PROPRIO               ,--
          ISNULL(J.VALOR                 ,0) AS FATURADOS                    ,--
          ISNULL(K.VALOR                 ,0) AS VALE_CREDITO                 ,--
          ISNULL(L.VALOR                 ,0) AS VALE_FUNCIONARIO             ,--
          ISNULL(M.VALOR                 ,0) AS DESPESAS                     ,--
          ISNULL(N.VALOR                 ,0) AS DEVOLUCAO                    ,--
          ISNULL(O.VALOR                 ,0) AS VALOR_AJUSTE_POS             

     FROM CONFERENCIAS_FECHAMENTOS_CAIXAS A WITH(NOLOCK)

     -- DADOS REFERENTE A ENVIOS DE NUMERÁRIOS PARA MATRIZ
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.ENVIO_DINHEIRO        )  AS ENVIO_DINHEIRO               ,
                   SUM(A.ENVIO_CHEQUE          )  AS ENVIO_CHEQUE                 ,
                   SUM(A.ENVIO_CHEQUE_PREDATADO)  AS ENVIO_CHEQUE_PREDATADO       
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_ENVIOS A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) B ON B.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE DEPOSITOS EM DINHEIRO
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.DEPOSITO_DINHEIRO)       AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_DINHEIRO A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) C ON C.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE DEPOSITOS EM CHEQUES
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.DEPOSITO_CHEQUE)         AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEP_CHEQUES A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) D ON D.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VENDAS TEF
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
          SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_TEF A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) E ON E.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VENDAS POS
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_POS A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) F ON F.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VENDAS CONVENIOS
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CONVENIOS A WITH(NOLOCK)                                               
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) G ON G.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VENDAS PBM
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_PBM A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) H ON H.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VENDAS CARTÃO PRÓPRIO
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_CPROPRIOS A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) I ON I.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VENDAS FATURADO
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_FATURADOS A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) J ON J.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VENDAS VALE CRÉDITOS
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_VCREDITOS A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) K ON K.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A VALES DE FUNCIONÁRIOS
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR)                   AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_VALES_FUNC A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) L ON L.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A DESPESAS
     LEFT               
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.DESPESA)                 AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DESPESAS A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) M ON M.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

     -- DADOS REFERENTE A DEVOLUÇÕES
     LEFT                                                       
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.TOTAL_DEVOLUCAO)         AS VALOR                        
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_DEV_DINHEIRO A WITH(NOLOCK)               
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA                 
             GROUP BY                                    
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) N ON N.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA    
                                                                                                       
     -- DADOS REFERENTE A AJUSTES NAS VENDAS POS                                                                                  
     LEFT
     JOIN ( SELECT A.CONFERENCIA_FECHAMENTO_CAIXA AS CONFERENCIA_FECHAMENTO_CAIXA ,
                   SUM(A.VALOR_AJUSTE)            AS VALOR                                              
              FROM CONFERENCIAS_FECHAMENTOS_CAIXAS_POS A WITH(NOLOCK)
             WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA 
             GROUP BY            
                   A.CONFERENCIA_FECHAMENTO_CAIXA ) O ON O.CONFERENCIA_FECHAMENTO_CAIXA = A.CONFERENCIA_FECHAMENTO_CAIXA

    WHERE A.CONFERENCIA_FECHAMENTO_CAIXA = @CONFERENCIA_FECHAMENTO_CAIXA               